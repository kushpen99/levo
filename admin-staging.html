<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Story Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mermaid -->
    <script src="https://unpkg.com/mermaid@9.4.3/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({ startOnLoad: false });</script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-2xl font-bold mb-4">📋 Story Admin</h1>

        <!-- AUTH -------------------------------------------------------------- -->
        <div class="mb-6" id="auth-section">
            <button id="sign-in-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Sign in with Google</button>
            <button id="sign-out-btn" class="bg-red-500  hover:bg-red-600 text-white px-4 py-2 rounded ml-2 hidden">Sign out</button>
        </div>

        <!-- MAIN UI ----------------------------------------------------------- -->
        <div id="admin-ui" class="hidden bg-white p-6 rounded shadow space-y-4">
            <!-- 1️⃣ Create-story button + hidden form -->
            <div class="mb-4">
                <button id="create-story-btn"
                        class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded">
                    ➕ Create New Story
                </button>

                <!-- hidden until clicked -->
                <div id="create-story-form" class="mt-4 p-4 bg-gray-50 rounded shadow hidden">
                    <div class="mb-3">
                        <label for="new-story-subject" class="block font-semibold mb-1">Story Subject</label>
                        <input id="new-story-subject" type="text"
                               class="border rounded px-3 py-2 w-full"
                               placeholder="e.g. ESBL Case" />
                    </div>
                    <div class="mb-3">
                        <label for="new-story-instr" class="block font-semibold mb-1">
                            Additional Instructions <span class="text-gray-500">(optional)</span>
                        </label>
                        <textarea id="new-story-instr" rows="3"
                                  class="border rounded px-3 py-2 w-full"
                                  placeholder="Give extra context…"></textarea>
                    </div>
                    <!-- Submit + spinner -->
                    <div class="flex items-center">
                        <button id="new-story-submit"
                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            <span id="new-story-submit-text">Submit</span>
                        </button>
                        <!-- Tailwind spinner, hidden by default -->
                        <svg id="new-story-spinner"
                             class="hidden animate-spin h-5 w-5 text-green-600 ml-2"
                             xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
                            <path class="opacity-75" fill="currentColor"
                                  d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" />
                        </svg>
                    </div>

                    <!-- per-form status message -->
                    <p id="new-story-status" class="mt-2 text-gray-700"></p>

                </div>
            </div>

            <!-- story select -->
            <div>
                <label for="story-select" class="font-semibold block mb-1">Existing Stories</label>
                <select id="story-select" class="border rounded px-3 py-2 w-full">
                    <option value="">-- Select a story --</option>
                </select>
            </div>

            <!-- story id / json -->
            <div>
                <label for="story-id" class="font-semibold block mb-1">Story ID</label>
                <input id="story-id" type="text" class="border rounded px-3 py-2 w-full" />
            </div>
            <div>
                <label for="story-status" class="font-semibold block mb-1">Status</label>
                <select id="story-status" class="border rounded px-3 py-2 w-auto inline-block">
                    <option value="draft">Draft</option>
                    <option value="review">Review</option>
                    <option value="published">Published</option>
                    <option value="archived">Archived</option>
                </select>
            </div>
            <!-- 🌟 Collapsible JSON Section -->
            <div id="json-section" class="space-y-1">
                <div class="flex items-center space-x-2 mb-1">
                    <label for="story-json" class="font-semibold">Story JSON</label>
                    <button id="toggle-json-btn"
                            class="text-blue-600 hover:underline text-sm">
                        Show
                    </button>
                </div>
                <div id="json-container" class="hidden">
                    <textarea id="story-json"
                              rows="15"
                              class="border rounded px-3 py-2 font-mono w-full text-sm"></textarea>
                </div>
            </div>

            <div class="flex space-x-2">
                <button id="upload-btn"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    Save Story
                </button>

                <!-- New Delete button -->
                <button id="delete-btn"
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    Delete Story
                </button>
                <button id="preview-btn"
                        class="flex items-center bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    <!-- standard “eye” icon SVG from Heroicons -->
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="w-5 h-5 mr-2"
                         fill="none" viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    Preview
                </button>

            </div>
            <p id="status-msg" class="mt-2"></p>

            <!-- PRESENTATION CONTROLS -->
            <div id="presentation-controls" class="hidden mt-6">
                <label for="presentation-select" class="font-semibold mr-2">View:</label>
                <select id="presentation-select" class="border rounded px-2 py-1"></select>
            </div>
            <div id="presentation-area" class="hidden bg-white p-4 rounded shadow mt-4 overflow-auto">
                <div id="presentation-content" class="space-y-4"></div>
            </div>
        </div>

        <!-- 💊 DRUGS ADMIN --------------------------------------------------- -->
        <div id="drugs-area" class="mt-8">
            <h2 class="text-lg font-bold mb-2">💊 Drugs</h2>

            <!-- toolbar -->
            <div class="flex items-center mb-3 space-x-3">
                <label for="drug-select" class="font-semibold">Existing drugs</label>
                <select id="drug-select" class="border rounded px-2 py-1 min-w-[12rem]">
                    <option value="">-- select --</option>
                </select>

                <button id="new-drug-btn"
                        class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded">
                    + New Drug
                </button>
                <button id="drug-ai-btn"
                        class="hidden bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded">
                    🧠 Generate from AI (empty fields only)
                </button>

            </div>

            <!-- editor -->
            <div id="drug-editor" class="hidden bg-gray-50 p-4 rounded shadow space-y-3">
                <div id="drug-ai-status" class="hidden">
                    
                </div>
                <div>
                    <label class="block font-semibold mb-1">Drug Name (ID)</label>
                    <input id="drug-name" type="text"
                           class="border rounded px-2 py-1 w-full">
                </div>

                <div id="drug-form" class="grid grid-cols-1 gap-4">
                    <!-- existing ones… -->
                    <div>
                        <label class="block font-semibold mb-1">Family (ex)</label>
                        <input id="drug-family-ex" type="text" class="border rounded px-2 py-1 w-full">
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Subclass (ex)</label>
                        <input id="drug-subclass-ex" type="text" class="border rounded px-2 py-1 w-full">
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Mechanism of action (ex)</label>
                        <input id="drug-mechanism-of-action-ex" type="text" class="border rounded px-2 py-1 w-full">
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Spectrum of coverage (ex)</label>
                        <textarea id="drug-spectrum-of-coverage-ex" rows="2" class="border rounded px-2 py-1 w-full"></textarea>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Major resistance mechanisms (ex)</label>
                        <textarea id="drug-major-resistance-mechanisms-ex" rows="2" class="border rounded px-2 py-1 w-full"></textarea>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Pharmacodynamics (ex)</label>
                        <textarea id="drug-pd-ex" rows="2" class="border rounded px-2 py-1 w-full"></textarea>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">PK (ex)</label>
                        <textarea id="drug-pk-ex" rows="2" class="border rounded px-2 py-1 w-full"></textarea>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Toxicity (ex)</label>
                        <textarea id="drug-toxicity-ex" rows="2" class="border rounded px-2 py-1 w-full"></textarea>
                    </div>
                    <!-- now the “-sum” fields -->
                    <div>
                        <label class="block font-semibold mb-1">Family (sum)</label>
                        <input id="drug-family-sum" type="text" class="border rounded px-2 py-1 w-full">
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Spectrum of coverage (sum)</label>
                        <input id="drug-spectrum-of-coverage-sum" type="text" class="border rounded px-2 py-1 w-full">
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">PK (sum)</label>
                        <input id="drug-pk-sum" type="text" class="border rounded px-2 py-1 w-full">
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Toxicity (sum)</label>
                        <input id="drug-toxicity-sum" type="text" class="border rounded px-2 py-1 w-full">
                    </div>
                </div>


                <div class="flex space-x-2">
                    <button id="drug-save-btn"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-1 rounded">
                        Save
                    </button>
                    <button id="drug-delete-btn"
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded hidden">
                        Delete
                    </button>
                    <button id="drug-cancel-btn"
                            class="bg-gray-300 hover:bg-gray-400 px-4 py-1 rounded">
                        Cancel
                    </button>
                </div>

                <p id="drug-status" class="text-sm"></p>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, serverTimestamp, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

        /* ----------------------------- ChatGpt -----------------------------*/
        const chatEndpoint = '/api/chat';

        /* ---------------------------- Firebase ---------------------------- */
        const firebaseConfig = {
            apiKey: "AIzaSyClEgpGrVTXT2zQNNDBDg0TNX2F24k6oTg",
            authDomain: "urushka99.firebaseapp.com",
            projectId: "urushka99",
            storageBucket: "urushka99.firebasestorage.app",
            messagingSenderId: "954120822793",
            appId: "1:954120822793:web:6c316b1b178081b56758d8",
            measurementId: "G-5LCB9E7PL9"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);


        /* ───────── DRUG-NAME VALIDATION ───────── */

        // simple memo so we never hit Firestore twice for the same name
        const drugCache = new Map();

        /**
         * Query Firestore once and remember the result.
         * Returns a Promise<boolean>.
         */
        function drugExists(name) {
            if (drugCache.has(name)) return drugCache.get(name);
            console.log("drugExists: in cache")

            const p = getDoc(doc(db, 'drugs', name))
                .then(snap => snap.exists())
                .catch(() => false);             // network / perm error → “missing”
            drugCache.set(name, p);
            console.log("drugExists: p")
            return p;
        }

        // ---------------- Drug-name colour helper ----------------
        function showAddDrugShortcut(inputEl) {
            // already attached?
            if (inputEl.parentElement.querySelector('.add-drug-btn')) return;

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = '+';
            btn.title = 'Add this drug';
            btn.className =
                'add-drug-btn absolute right-2 top-1 z-20 ' +      // position
                'flex items-center justify-center ' +               // center the glyph
                'w-7 h-7 rounded-full shadow-sm ' +                 // 28 × 28 px circle
                'bg-white border border-blue-500 ' +                // outline
                'text-blue-600 font-semibold text-lg leading-none ' + // bigger, bold “＋”
                'hover:bg-blue-50';
            btn.onclick = e => {
                e.stopPropagation();
                openDrugEditor(inputEl.value.trim());
                // scroll to the drugs panel
                document.getElementById('drugs-area').scrollIntoView({ behavior: 'smooth' });
            };

            // make the containing <td> relative so absolute coords work
            inputEl.parentElement.style.position = 'relative';
            inputEl.parentElement.append(btn);
        }

        function hideAddDrugShortcut(inputEl) {
            const btn = inputEl.parentElement.querySelector('.add-drug-btn');
            if (btn) btn.remove();
        }

        async function paintDrugInput(inputEl) {
            const name = inputEl.value.trim();

            // scrub any previous colours
            inputEl.classList.remove('bg-emerald-100', 'bg-rose-100');

            if (!name) { hideAddDrugShortcut(inputEl); return; }

            if (await drugExists(name)) {
                inputEl.classList.add('bg-emerald-100');
                hideAddDrugShortcut(inputEl);
            } else {
                inputEl.classList.add('bg-rose-100');
                console.log("paintDrugInput: showAddDrugShortcut");
                showAddDrugShortcut(inputEl);
            }
        }



        /* ------------------------------ UI -------------------------------- */
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const adminUI = document.getElementById('admin-ui');

        const storySelect = document.getElementById('story-select');
        const storyIdInput = document.getElementById('story-id');
        const statusSelect = document.getElementById('story-status');
        const toggleJsonBtn = document.getElementById('toggle-json-btn');
        const jsonContainer = document.getElementById('json-container');
        const storyJsonArea = document.getElementById('story-json');
        const uploadBtn = document.getElementById('upload-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const previewBtn = document.getElementById('preview-btn');
        const createBtn = document.getElementById('create-story-btn');
        const createForm = document.getElementById('create-story-form');
        const subjectInput = document.getElementById('new-story-subject');
        const instrInput = document.getElementById('new-story-instr');
        const submitBtn = document.getElementById('new-story-submit');
        const spinner = document.getElementById('new-story-spinner');
        const newStoryStatus = document.getElementById('new-story-status');

        const statusMsg = document.getElementById('status-msg');

        const presControls = document.getElementById('presentation-controls');
        const presSelect = document.getElementById('presentation-select');
        const presArea = document.getElementById('presentation-area');
        const presContent = document.getElementById('presentation-content');

        /* drugs UI handles */
        const drugSelect = document.getElementById('drug-select');
        const newDrugBtn = document.getElementById('new-drug-btn');
        const drugAiBtn = document.getElementById('drug-ai-btn');
        const drugEditor = document.getElementById('drug-editor');
        const drugAiStatus = document.getElementById('drug-ai-status');
        const drugForm = document.getElementById('drug-form');

        const drugNameEl = document.getElementById('drug-name');

        const drugFamilyExEl = document.getElementById('drug-family-ex');
        const drugSubclassExEl = document.getElementById('drug-subclass-ex');
        const drugMoAExEl = document.getElementById('drug-mechanism-of-action-ex');
        const drugSpectrumExEl = document.getElementById('drug-spectrum-of-coverage-ex');
        const drugMajorResExEl = document.getElementById('drug-major-resistance-mechanisms-ex');
        const drugPdExEl = document.getElementById('drug-pd-ex');
        const drugPkExEl2 = document.getElementById('drug-pk-ex');               // rename local var if needed
        const drugToxExEl = document.getElementById('drug-toxicity-ex');

        const drugFamilySumEl = document.getElementById('drug-family-sum');
        const drugSpectrumSumEl = document.getElementById('drug-spectrum-of-coverage-sum');
        const drugPkSumEl = document.getElementById('drug-pk-sum');
        const drugToxicitySumEl = document.getElementById('drug-toxicity-sum');



        const drugSaveBtn = document.getElementById('drug-save-btn');
        const drugDeleteBtn = document.getElementById('drug-delete-btn');
        const drugCancelBtn = document.getElementById('drug-cancel-btn');
        const drugStatus = document.getElementById('drug-status');


        /* ───────── view-state memory ───────── */
        let currentMode = null;   // 'graph', 'quiz', 'summary', …
        let currentGraphView = 'graphic'; // 'graphic' | 'table'

        /* ───────── view-refresh guard ───────── */
        let suppressPresentation = false;   // true only while we programmatically
        // change the JSON textarea

        /* ----------------------------- Auth ------------------------------- */
        signInBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => showStatus(e.message, 'text-red-600'));
        signOutBtn.onclick = () => signOut(auth);

        onAuthStateChanged(auth, user => {
            const logged = !!user;
            signInBtn.classList.toggle('hidden', logged);
            signOutBtn.classList.toggle('hidden', !logged);
            adminUI.classList.toggle('hidden', !logged);
            if (logged) {
                loadStories();
                loadDrugs();
            }
        });

        /* --------------------- Firestore helpers -------------------------- */
        async function loadStories() {
            storySelect.innerHTML = '<option value="">-- Select a story --</option>';
            const snap = await getDocs(collection(db, 'stories'));
            snap.forEach(docSnap => {
                const opt = document.createElement('option');
                opt.value = docSnap.id;
                const d = docSnap.data();
                opt.textContent = d.title || d.name || docSnap.id;
                storySelect.append(opt);
            });
        }

        /* ───────────── DRUGS CRUD ───────────── */

        async function loadDrugs() {
            const sel = document.getElementById('drug-select');
            sel.innerHTML = '<option value="">-- select --</option>';
            const snap = await getDocs(collection(db, 'drugs'));
            snap.forEach(d => {
                const o = new Option(d.id, d.id);
                sel.append(o);
            });
        }

        async function saveDrug() {
            const id = drugNameEl.value.trim();
            if (!id) return setDrugStatus('Drug name required', 'text-red-600');

            const payload = {
                'family-ex': drugFamilyExEl.value.trim(),
                'subclass-ex': drugSubclassExEl.value.trim(),
                'mechanism-of-action-ex': drugMoAExEl.value.trim(),
                'spectrum-of-coverage-ex': drugSpectrumExEl.value.trim(),
                'major-resistance-mechanisms-ex': drugMajorResExEl.value.trim(),
                'pd-ex': drugPdExEl.value.trim(),
                'pk-ex': drugPkExEl2.value.trim(),
                'toxicity-ex': drugToxExEl.value.trim(),

                'family-sum': drugFamilySumEl.value.trim(),
                'spectrum-of-coverage-sum': drugSpectrumSumEl.value.trim(),
                'pk-sum': drugPkSumEl.value.trim(),
                'toxicity-sum': drugToxicitySumEl.value.trim(),
            };

            await setDoc(doc(db, 'drugs', id), payload);
            // … rest of your existing save logic
        }


        async function deleteDrug() {
            const id = drugSelect.value;
            if (!id) return;
            const ok = confirm(`Delete drug “${id}” permanently?`);
            if (!ok) return;
            await deleteDoc(doc(db, 'drugs', id));
            setDrugStatus(`Drug “${id}” deleted`, 'text-green-600');
            resetDrugEditor();
            await loadDrugs();
            invalidateDrugCache(id);
        }

        function openDrugEditor(id = '') {
            drugEditor.classList.remove('hidden');
            drugAiBtn.classList.remove('hidden');

            if (id) {

                // load existing doc
                getDoc(doc(db, 'drugs', id)).then(snap => {
                    if (snap.exists()) {
                        const d = snap.data();
                        drugNameEl.value = id;
                        drugFamilyExEl.value = d['family-ex'] || '';
                        drugSubclassExEl.value = d['subclass-ex'] || '';
                        drugMoAExEl.value = d['mechanism-of-action-ex'] || '';
                        drugSpectrumExEl.value = d['spectrum-of-coverage-ex'] || '';
                        drugMajorResExEl.value = d['major-resistance-mechanisms-ex'] || '';
                        drugPdExEl.value = d['pd-ex'] || '';
                        drugPkExEl2.value = d['pk-ex'] || '';
                        drugToxExEl.value = d['toxicity-ex'] || '';

                        drugFamilySumEl.value = d['family-sum'] || '';
                        drugSpectrumSumEl.value = d['spectrum-of-coverage-sum'] || '';
                        drugPkSumEl.value = d['pk-sum'] || '';
                        drugToxicitySumEl.value = d['toxicity-sum'] || '';

                        drugDeleteBtn.classList.remove('hidden');
                    } else {
                        // new doc with prefilled name
                        drugNameEl.value = id;
                        drugFamilyExEl.value = '';
                        drugSubclassExEl.value = '';
                        drugMoAExEl.value = '';
                        drugSpectrumExEl.value = '';
                        drugMajorResExEl.value = '';
                        drugPdExEl.value = '';
                        drugPkExEl2.value = '';
                        drugToxExEl.value = '';

                        drugFamilySumEl.value = '';
                        drugSpectrumSumEl.value = '';
                        drugPkSumEl.value = '';
                        drugToxicitySumEl.value = '';

                        drugDeleteBtn.classList.add('hidden');
                    }
                });
            } else {
                resetDrugEditor();
            }
        }

        function resetDrugEditor() {
            drugEditor.classList.add('hidden');
            drugAiBtn.classList.add('hidden');
            [drugNameEl, drugFamilyEl, drugPkEl,
                drugSpectrumEl, drugToxEl].forEach(el => el.value = '');
            drugDeleteBtn.classList.add('hidden');
            setDrugStatus('');
        }

        // ——————————————————————————————————————————————————
        //  Helpers for your dynamic form
        // ——————————————————————————————————————————————————

        /**
         * Inserts one <fieldset> into your form, with:
         *  • an input for the key name  
         *  • an input for the value  
         *  • a delete button
         */
        function addDrugAiFieldRow(key = '', val = '') {
            
            const d = document.createElement('div');
            
            // input
            const inp = document.createElement('input');
            inp.placeholder = 'field name';
            inp.value = val;
            inp.type = 'text';
            inp.className = 'border rounded px-2 py-1 w-full';

            // label
            const lbl = document.createElement('lavel');
            lbl.placeholder = 'value';
            vallblInp.value = key;
            lbl.className = 'block font-semibold mb-1';

            // delete button
            const del = document.createElement('button');
            del.type = 'button';
            del.textContent = '🗑';
            del.className = 'text-red-600 hover:text-red-800';
            del.onclick = () => fs.remove();

            d.append(lbl, inp, del);

            // insert before “Add field” if it exists, otherwise at end
            const addBtn = drugForm.querySelector('button[type="button"]');
            if (addBtn) drugForm.insertBefore(d, addBtn);
            else drugForm.append(d);
        }


        async function generateDrugInfoByAI() {
            clearDrugAiStatus();
            drugAiBtn.disabled = true;
            try {
                // 1) build your prompt however you like—here’s a placeholder:
                const prompt = `You are an expert clinical pharmacologist and researcher.  
When given a drug name, fetch its pharmacologic and microbiologic data **only** from authoritative, publicly-available sources (e.g. PubChem, DrugBank, FDA drug labels, WHO Essential Medicines List, up-to-date peer-reviewed literature).  

**Output must be valid JSON, with exactly these keys** (no extra fields):

{
  "drug_id":        "string",  // e.g. RxNorm ID or PubChem CID
  "name":           "string",
  "family-ex":      "string",  // extended description
  "subclass-ex":    "string",
  "mechanism-of-action-ex":         "string",
  "spectrum-of-coverage-ex":        "string",
  "major-resistance-mechanisms-ex": "string",
  "pd-ex":          "string",  // pharmacodynamics
  "pk-ex":          "string",  // pharmacokinetics
  "toxicity-ex":    "string",
  "family-sum":     "string",  // 1–2 sentence summary
  "spectrum-of-coverage-sum":    "string",
  "pk-sum":        "string",
  "toxicity-sum":  "string",
  "sources":      ["string"]    // list of URLs or PubMed IDs you used
}

**Guidelines**  
1. For every ' - ex' field, give a detailed, referenced description (include in-line citations if possible).  
2. For every '- sum' field, give a concise 1–2 sentence bullet-style summary.  
3. List all your references in the """sources""" array.  
4. Do **not** output any explanation outside of the JSON.  

Here is the drug to look up:
${ drugNameEl.value }
`;
                // 2) call your AI endpoint
                const res = await fetch(chatEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        prompt
                    })
                });

                if (!res.ok) throw new Error(await res.text());

                const { reply } = await res.json();

                // 3) clean code fences (if any) and parse JSON
                let txt = reply.trim();
                if (txt.startsWith('```')) {
                    txt = txt.replace(/^```(?:json)?\s*/, '').replace(/```$/, '');
                }
                const aiData = JSON.parse(txt);

                // 4) merge into the form, but don't overwrite non‐empty fields
                Object.entries(aiData).forEach(([key, value]) => {
                    // look for an existing row whose key input === `key`
                    const row = Array.from(drugForm.querySelectorAll('fieldset')).find(fs => {
                        return fs.querySelector('input').value === key;
                    });
                    if (row) {
                        const valInput = row.querySelectorAll('input')[1];
                        if (!valInput.value) valInput.value = value;
                    } else {
                        // if it doesn't exist, add a new row
                        addDrugAiFieldRow(key, value);
                    }
                });

                setDrugAiSuccess('✔ AI data populated (existing fields untouched)');
            } catch (err) {
                setDrugAiError('AI generation failed: ' + err.message);
            } finally {
                drugAiBtn.disabled = false;
            }
        }

        function clearDrugAiStatus() {
            drugAiStatus.textContent = '';
            drugAiStatus.className = '';
            drugAiStatus.classList.add('hidden');
        }

        function setDrugAiError(msg) {
            drugAiStatus.classList.remove('hidden');
            drugAiStatus.textContent = msg;
            drugAiStatus.className = 'text-red-600';
        }

        function setDrugAiSuccess(msg) {
            drugAiStatus.classList.remove('hidden');
            drugAiStatus.textContent = msg;
            statdrugAiStatusus.className = 'text-green-600';
        }

        

        function setDrugStatus(msg = '', cls = '') {
            drugStatus.textContent = msg;
            drugStatus.className = cls;
        }

        /* invalidate one entry in the exists-cache */
        function invalidateDrugCache(name) {
            drugCache.delete(name);
        }


        /* --------------------------- UI logic ----------------------------- */
        storySelect.onchange = async () => {
            const id = storySelect.value;
            if (!id) return hidePresentation();
            const snap = await getDoc(doc(db, 'stories', id));
            if (!snap.exists()) return hidePresentation();
            const data = snap.data();
            storyIdInput.value = id;
            storyJsonArea.value = orderKeys(data);
            setupPresentation();
            try {
                const full = JSON.parse(storyJsonArea.value);
                statusSelect.value = full.status || 'Draft';
            } catch {/* ignore if JSON invalid */ }
        };

        storyJsonArea.oninput = () => {

            if (suppressPresentation) {        // ← skip redraw during quiet updates
                suppressPresentation = false;
                return;
            }

            try {
                JSON.parse(storyJsonArea.value);
            }
            catch { return; }
            setupPresentation();
            try {
                const full = JSON.parse(storyJsonArea.value);
                statusSelect.value = full.status || 'Draft';
            } catch {/* ignore if JSON invalid */ }
        };

        statusSelect.onchange = () => {
            let full;
            try {
                full = JSON.parse(storyJsonArea.value);
            } catch {
                return;
            }
            full.status = statusSelect.value;
            storyJsonArea.value = JSON.stringify(full, null, 2);
            setupPresentation();
        };


        toggleJsonBtn.onclick = () => {
            const isNowHidden = jsonContainer.classList.toggle('hidden');
            toggleJsonBtn.textContent = isNowHidden ? 'Show' : 'Hide';
        };

        /* drugs UI events */
        newDrugBtn.onclick = () => openDrugEditor('');
        drugAiBtn.onclick = () => generateDrugInfoByAI();
        drugSelect.onchange = () => openDrugEditor(drugSelect.value);
        drugSaveBtn.onclick = saveDrug;
        drugDeleteBtn.onclick = deleteDrug;
        drugCancelBtn.onclick = resetDrugEditor;

        /* ------------------------ Presentation ---------------------------- */
        function setupPresentation() {
            let data;
            try { data = JSON.parse(storyJsonArea.value); } catch { return hidePresentation(); }

            // keep whatever was selected before the re-render
            const prev = currentMode ?? presSelect.value;

            presSelect.innerHTML = '';

            const views = [];
            if (data.scenarios) views.push(['graph', 'Graph']);
            if (data.drugInfo) views.push(['drugInfo', 'Drug Info']);
            if (data.quiz) views.push(['quiz', 'Quiz']);
            if (data.summary) views.push(['summary', 'Summary']);
            if (!views.length) return hidePresentation();
            views.forEach(([val, label]) => {
                const o = new Option(label, val);
                presSelect.append(o);
            });
            presControls.classList.remove('hidden');
            presArea.classList.remove('hidden');
            presSelect.onchange = renderPresentation;
            // restore previous main view if still available, else default
            presSelect.value = views.some(v => v[0] === prev) ? prev : views[0][0];
            renderPresentation();
        }

        function renderPresentation() {
            let data;
            try { data = JSON.parse(storyJsonArea.value); } catch { return; }
            presContent.innerHTML = '';
            const mode = presSelect.value;
            currentMode = mode;                 // <-- remember
            if (mode === 'graph') renderGraphView(data);
            else if (mode === 'drugInfo') renderDrugInfo(data);
            else if (mode === 'quiz') renderQuiz(data);
            else if (mode === 'summary') renderSummary(data);
        }

        /* -------------------- GRAPH VIEW ------------------------- */
        function renderGraphView(data) {
            // switch between graphic & table views
            const topBar = document.createElement('div');
            topBar.className = 'flex items-center justify-between mb-2';

            const viewSel = document.createElement('select');
            viewSel.className = 'border rounded px-2 py-1';
            viewSel.innerHTML = '<option value="graphic">Graphic</option><option value="table">Table</option>';
            topBar.append(viewSel);
            presContent.append(topBar);

            const holder = document.createElement('div');
            presContent.append(holder);

            // restore last picked sub-view
            viewSel.value = currentGraphView;
            viewSel.onchange = () => {
                currentGraphView = viewSel.value;   // remember choice
                draw(currentGraphView);
            };

            draw(currentGraphView);

            function draw(kind) {
                holder.innerHTML = '';
                if (kind === 'graphic') {
                    drawGraphic(holder, data);
                } else {
                    drawScenarioTable(holder);
                }
            }

            function drawGraphic(container, d) {
                const nodes = [], edges = [], idMap = {};
                Object.entries(d.scenarios || {}).forEach(([k, s], i) => {
                    idMap[k] = 'n' + i;
                    nodes.push(`${idMap[k]}["${(s.name || '').replace(/"/g, '\\"').replace(/\n/g, ' ')}"]`);
                });
                Object.entries(d.scenarios || {}).forEach(([k, s]) => {
                    const from = idMap[k];
                    (s.options || []).forEach(o => {
                        const to = idMap[o.id || o.next || o.target];
                        if (to) edges.push(`${from} -->|${(o.text || '').replace(/"/g, '\\"').replace(/\n/g, ' ')}| ${to}`);
                    });
                });

                // build style directives
                const styleLines = [];
                Object.entries(d.scenarios || {}).forEach(([k, s]) => {
                    const nid = idMap[k];
                    if (s.pathResult === 'success') {
                        styleLines.push(`style ${nid} fill:#ccffcc`);
                    } else if (s.pathResult === 'failure') {
                        styleLines.push(`style ${nid} fill:#ffcccc`);
                    }
                });

                const diagram = [
                    'flowchart LR',
                    ...nodes,
                    ...edges,
                    ...styleLines    // ← apply our conditional node styles
                ].join('\n');

                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = diagram;
                container.append(div);

                /* Mermaid error output */
                const mermaidError = document.createElement('div');
                mermaidError.className = 'hidden text-red-600 text-sm whitespace-pre-wrap mt-2';
                mermaidError.id = "mermaid-error";
                container.append(mermaidError);

                mermaid.init(undefined, div);

                // display any syntax / parse error inside the page
                mermaid.parseError = (err /* Error object */, hash /* details */) => {

                    mermaidError.textContent =
                        'Mermaid syntax error:\n' + (err.str || err.message || err.toString());

                    mermaidError.classList.remove('hidden');
                };
            }


            function drawScenarioTable(container) {
                const addBtn = document.createElement('button');
                addBtn.textContent = 'Add Scenario';
                addBtn.className = 'mb-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded';
                addBtn.onclick = () => {
                    const full = JSON.parse(storyJsonArea.value);
                    full.scenarios = full.scenarios || {};
                    let idx = 1; while (full.scenarios['NEW' + idx]) idx++;
                    full.scenarios['NEW' + idx] = { name: '', text: '', options: [] };
                    storyJsonArea.value = JSON.stringify(full, null, 2);
                    renderPresentation();
                };
                container.append(addBtn);

                const table = document.createElement('table');
                table.className = 'table-auto w-full border-collapse';
                table.innerHTML = `<thead><tr class='bg-gray-50'>
                                                                <th class='border px-2 py-1'>ID</th>
                                                                <th class='border px-2 py-1'>Name</th>
                                                                <th class='border px-2 py-1'>Text</th>
                                                                <th class='border px-2 py-1'>Result</th>
                                                                <th class='border px-2 py-1'>Options</th>
                                                                <th class='border px-2 py-1'>Remove</th>
                                                            </tr></thead>`;
                const tbody = document.createElement('tbody');
                Object.entries(data.scenarios || {}).forEach(([id, sc]) => {
                    const tr = document.createElement('tr');
                    tr.append(tdPlain(id));
                    tr.append(tdInput(sc.name || '', val => updateField(id, 'name', val)));
                    tr.append(tdTextarea(sc.text || '', val => updateField(id, 'text', val), 'w-96'));
                    const tdRes = document.createElement('td');
                    tdRes.className = 'border px-2 py-1';

                    const sel = document.createElement('select');
                    sel.className = 'border rounded px-1 py-0.5';

                    // the three allowed values
                    const choices = ['undetermined', 'success', 'failure'];
                    choices.forEach(val => {
                        const opt = document.createElement('option');
                        opt.value = val;
                        // capitalize first letter
                        opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
                        if ((sc.pathResult || 'undetermined') === val) opt.selected = true;
                        sel.append(opt);
                    });

                    // when changed, update the JSON
                    sel.onchange = () => updateField(id, 'pathResult', sel.value);

                    tdRes.append(sel);
                    tr.append(tdRes);

                    tr.append(createOptionsCell(id, sc.options || []));

                    const tdRem = document.createElement('td');
                    tdRem.className = 'border px-2 py-1 text-center';
                    const rm = document.createElement('button');
                    rm.textContent = '🗑';
                    rm.onclick = () => { const full = JSON.parse(storyJsonArea.value); delete full.scenarios[id]; storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); };
                    tdRem.append(rm);
                    tr.append(tdRem);
                    tbody.append(tr);
                });
                table.append(tbody);
                container.append(table);

                function tdPlain(txt) { const td = document.createElement('td'); td.className = 'border px-2 py-1 text-xs break-all'; td.textContent = txt; return td; }
                function tdInput(val, cb, valClass = '') {
                    const td = document.createElement('td'); td.className = `border px-2 py-1 ${valClass}`; const inp = document.createElement('input'); inp.type = 'text'; inp.value = val; inp.className = 'border rounded px-1 py-0.5 w-full'; inp.oninput = () => cb(inp.value); td.append(inp); return td;
                }
                function tdTextarea(val, cb, expandedRows = 4) {
                    const td = document.createElement('td');
                    td.className = 'border px-2 py-1';

                    const ta = document.createElement('textarea');
                    // start single‐line high
                    ta.rows = 1;
                    ta.value = val;
                    ta.className = 'border rounded px-1 py-0.5 w-full resize-none overflow-hidden';
                    ta.style.transition = 'height 0.2s';

                    // when focused, expand...
                    ta.addEventListener('focus', () => {
                        ta.rows = expandedRows;
                        // auto‐grow to content
                        ta.style.height = 'auto';
                        ta.style.height = ta.scrollHeight + 'px';
                    });

                    // ...and collapse back on blur
                    ta.addEventListener('blur', () => {
                        ta.rows = 1;
                        ta.style.height = 'auto';
                    });

                    // also update JSON on every change
                    ta.addEventListener('input', () => {
                        cb(ta.value);
                        // if still focused, keep growing
                        if (document.activeElement === ta) {
                            ta.style.height = 'auto';
                            ta.style.height = ta.scrollHeight + 'px';
                        }
                    });

                    td.append(ta);
                    return td;
                }


                function updateField(sid, key, value) { const full = JSON.parse(storyJsonArea.value); full.scenarios[sid][key] = value; storyJsonArea.value = JSON.stringify(full, null, 2); }
            }

            /**
              * Builds a <td> with:
              *  - “Edit…” button
              *  - hidden .options-editor panel
              */
            function createOptionsCell(sid, optionsArr) {
                const td = document.createElement('td');
                td.className = 'border px-2 py-1 align-top';

                // 1) Edit button
                const btn = document.createElement('button');
                btn.textContent = 'Edit…';
                btn.className = 'bg-gray-200 hover:bg-gray-300 text-sm px-2 py-1 rounded';
                td.append(btn);

                // 2) Editor panel (hidden initially)
                const panel = document.createElement('div');
                panel.className = 'options-editor hidden mt-2 p-2 bg-gray-50 rounded shadow';
                td.append(panel);

                // 3) When clicked, toggle & render
                btn.onclick = () => {
                    panel.classList.toggle('hidden');
                    if (!panel._rendered) {
                        renderOptionsEditor(sid, panel);
                        panel._rendered = true;
                    }
                };

                return td;
            }



            /**
            * Renders the list of option rows inside the given panel.
            * Hooks up add/remove and value-change callbacks.
            */
            function renderOptionsEditor(sid, panel) {
                // clear
                panel.innerHTML = '';

                // get the latest array from the JSON text
                let full;
                try { full = JSON.parse(storyJsonArea.value); }
                catch { return; }
                const opts = full.scenarios[sid].options = full.scenarios[sid].options || [];

                // 5) 'Done' button – closes panel & refreshes preview
                const doneBtn = document.createElement('button');
                doneBtn.textContent = '✓ Done';
                doneBtn.className = 'ml-2 bg-gray-300 hover:bg-gray-400 text-xs px-2 py-1 rounded';
                doneBtn.onclick = () => {
                    panel.classList.add('hidden');   // minimise the panel
                    renderPresentation();            // refresh preview once
                };
                panel.append(doneBtn);

                // 1) Table skeleton
                const tbl = document.createElement('table');
                tbl.className = 'w-full mb-2';
                tbl.innerHTML = `
                    <thead class="text-left text-sm text-gray-600">
                    <tr>
                      <th class="py-1">Text</th>
                      <th class="py-1">Id</th>
                      <th class="py-1">Drug</th>
                      <th></th>
                    </tr>
                  </thead>
                  `;
                const tbody = document.createElement('tbody');
                tbl.append(tbody);
                panel.append(tbl);

                // 2) Helper to rebuild rows
                function rebuild() {
                    tbody.innerHTML = '';
                    // reload opts in case they changed
                    full.scenarios[sid].options = opts;
                    opts.forEach((o, i) => {
                        const tr = document.createElement('tr');
                        tr.className = 'align-top';

                        // label cell
                        const tdLabel = document.createElement('td');
                        tdLabel.className = 'py-1 pr-2';
                        const inpLabel = document.createElement('input');
                        inpLabel.type = 'text';
                        inpLabel.value = o.text || '';
                        inpLabel.className = 'border rounded px-1 py-0.5 w-full';
                        inpLabel.oninput = () => {
                            o.text = inpLabel.value;
                            pushJson();
                        };

                        tdLabel.append(inpLabel);
                        tr.append(tdLabel);

                        // target-ID cell
                        const tdNext = document.createElement('td');
                        tdNext.className = 'py-1 pr-2';
                        const sel = document.createElement('select');
                        sel.className = 'border rounded px-1 py-0.5 w-full';
                        // populate with current scenario keys
                        Object.keys(full.scenarios).sort().forEach(key => {
                            const optEl = document.createElement('option');
                            optEl.value = key;
                            optEl.textContent = key;
                            if (o.id === key) optEl.selected = true;
                            sel.append(optEl);
                        });
                        sel.onchange = () => {
                            o.id = sel.value;
                            pushJson();
                        };
                        tdNext.append(sel);
                        tr.append(tdNext);

                        // — Drug column —
                        const tdDrug = document.createElement('td');
                        tdDrug.className = 'py-1 pr-2 relative';
                        const inpDrug = document.createElement('input');
                        inpDrug.type = 'text';
                        inpDrug.value = o.drugName || '';
                        inpDrug.className = 'border rounded px-1 py-0.5 w-full pr-10';
                        inpDrug.oninput = () => {
                            o.drugName = inpDrug.value;
                            pushJson();
                            paintDrugInput(inpDrug);
                        };
                        inpDrug.addEventListener('blur', () => {
                            paintDrugInput?.(inpDrug);    // keep colour up-to-date (optional)
                        });
                        tdDrug.append(inpDrug);
                        paintDrugInput(inpDrug);
                        tr.append(tdDrug);


                        // remove button
                        const tdRem = document.createElement('td');
                        tdRem.className = 'py-1 text-center';
                        const rmBtn = document.createElement('button');
                        rmBtn.textContent = '✕';
                        rmBtn.className = 'text-red-500 hover:text-red-700';
                        rmBtn.onclick = () => {
                            opts.splice(i, 1);
                            pushJson();
                            rebuild();
                        };
                        tdRem.append(rmBtn);
                        tr.append(tdRem);

                        tbody.append(tr);
                    });
                }

                // 3) “Add Option” button
                const addBtn = document.createElement('button');
                addBtn.textContent = '+ Add Option';
                addBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white text-sm px-2 py-1 rounded';
                addBtn.onclick = () => {
                    opts.push({ text: '', id: Object.keys(full.scenarios)[0] || '' });
                    pushJson();
                    rebuild();
                };
                panel.append(addBtn);

                // 4) pushJson: update the textarea & re-render presentation
                function pushJson() {
                    suppressPresentation = true;       // prevent oninput from redrawing
                    storyJsonArea.value = JSON.stringify(full, null, 2);
                }

                // initial render
                rebuild();
            }

        }

        /* --------------------- OTHER RENDERERS ------------------------------ */
        function renderSummary(data) {
            const ta = document.createElement('textarea');
            ta.className = 'border rounded px-2 py-1 w-full h-32';
            ta.value = (data.summary?.points || []).join('\n');
            ta.oninput = () => { const full = JSON.parse(storyJsonArea.value); full.summary = { points: ta.value.split('\n') }; storyJsonArea.value = JSON.stringify(full, null, 2); };
            presContent.append(ta);
        }

        function renderQuiz(data) {
            const add = document.createElement('button'); add.textContent = 'Add Question'; add.className = 'mb-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded';
            add.onclick = () => { const full = JSON.parse(storyJsonArea.value); full.quiz = full.quiz || { choices: [] }; full.quiz.choices.push({ id: `Q${full.quiz.choices.length + 1}`, question: '', options: [], correct: '' }); storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); };
            presContent.append(add);
            const table = document.createElement('table'); table.className = 'table-auto w-full border-collapse'; table.innerHTML = `<thead><tr class='bg-gray-50'><th class='border px-2 py-1'>#</th><th class='border px-2 py-1'>ID</th><th class='border px-2 py-1'>Question</th><th class='border px-2 py-1'>Options (comma)</th><th class='border px-2 py-1'>Correct</th><th class='border px-2 py-1'>Remove</th></tr></thead>`;
            const tbody = document.createElement('tbody');
            (data.quiz?.choices || []).forEach((c, i) => {
                const tr = document.createElement('tr');
                tr.append(tdPlain(i + 1));
                tr.append(tdInput(c.id || '', v => update(i, 'id', v)));
                tr.append(tdInput(c.question || '', v => update(i, 'question', v), 'w-64'));
                tr.append(tdInput((c.options || []).join(', '), v => update(i, 'options', v.split(',').map(s => s.trim()).filter(Boolean)), 'w-64'));
                tr.append(tdInput(c.correct || '', v => update(i, 'correct', v)));
                const td = document.createElement('td'); td.className = 'border px-2 py-1 text-center';
                const rm = document.createElement('button'); rm.textContent = '🗑'; rm.onclick = () => { const full = JSON.parse(storyJsonArea.value); full.quiz.choices.splice(i, 1); storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); }; td.append(rm); tr.append(td);
                tbody.append(tr);
            });
            table.append(tbody); presContent.append(table);
            function tdPlain(t) { const td = document.createElement('td'); td.className = 'border px-2 py-1'; td.textContent = t; return td; }
            function tdInput(v, cb, cls = '') { const td = document.createElement('td'); td.className = `border px-2 py-1 ${cls}`; const inp = document.createElement('input'); inp.type = 'text'; inp.value = v; inp.className = 'border rounded px-1 py-0.5 w-full'; inp.oninput = () => cb(inp.value); td.append(inp); return td; }
            function update(i, k, v) { const full = JSON.parse(storyJsonArea.value); full.quiz.choices[i][k] = v; storyJsonArea.value = JSON.stringify(full, null, 2); }
        }

        function renderDrugInfo(data) {
            const add = document.createElement('button'); add.textContent = 'Add Drug'; add.className = 'mb-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded';
            add.onclick = () => { const full = JSON.parse(storyJsonArea.value); full.drugInfo = full.drugInfo || {}; let n = 1; while (full.drugInfo['Drug' + n]) n++; full.drugInfo['Drug' + n] = { Family: '', PK: '', Spectrum: '', Toxicities: '' }; storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); };
            presContent.append(add);

            const table = document.createElement('table'); table.className = 'table-auto w-full border-collapse'; table.innerHTML = `<thead><tr class='bg-gray-50'><th class='border px-2 py-1'>Name</th><th class='border px-2 py-1'>Family</th><th class='border px-2 py-1'>PK</th><th class='border px-2 py-1'>Spectrum</th><th class='border px-2 py-1'>Toxicities</th><th class='border px-2 py-1'>Remove</th></tr></thead>`;
            const tbody = document.createElement('tbody');
            Object.entries(data.drugInfo || {}).forEach(([name, info]) => {
                const tr = document.createElement('tr');
                tr.append(tdInput(name, v => renameDrug(name, v)));
                ['Family', 'PK', 'Spectrum', 'Toxicities'].forEach(f => tr.append(tdInput(info[f] || '', v => updateDrug(name, f, v))));
                const tdR = document.createElement('td'); tdR.className = 'border px-2 py-1 text-center'; const rm = document.createElement('button'); rm.textContent = '🗑'; rm.onclick = () => { const full = JSON.parse(storyJsonArea.value); delete full.drugInfo[name]; storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); }; tdR.append(rm); tr.append(tdR);
                tbody.append(tr);
            }); table.append(tbody); presContent.append(table);
            function tdInput(v, cb) { const td = document.createElement('td'); td.className = 'border px-2 py-1'; const inp = document.createElement('input'); inp.type = 'text'; inp.value = v; inp.className = 'border rounded px-1 py-0.5 w-full'; inp.oninput = () => cb(inp.value); td.append(inp); return td; }
            function renameDrug(oldN, newN) { if (!newN || oldN === newN) return; const full = JSON.parse(storyJsonArea.value); if (full.drugInfo[newN]) return; full.drugInfo[newN] = { ...full.drugInfo[oldN] }; delete full.drugInfo[oldN]; storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); }
            function updateDrug(n, f, val) { const full = JSON.parse(storyJsonArea.value); full.drugInfo[n][f] = val; storyJsonArea.value = JSON.stringify(full, null, 2); }
        }

        /* ------------------------- UTILITIES ------------------------------- */
        function orderKeys(data) {
            // ---------- top-level ----------
            const topOrder = ['title', 'status', 'createdAt', 'updatedAt',
                'scenarios', 'drugInfo', 'summary', 'quiz'];

            const result = {};
            topOrder.forEach(k => { if (data[k] !== undefined) result[k] = data[k]; });
            Object.keys(data).forEach(k => { if (!result.hasOwnProperty(k)) result[k] = data[k]; });

            // ---------- per-scenario ----------
            if (result.scenarios) {
                const sorted = {};
                Object.keys(result.scenarios)
                    .sort((a, b) => a.localeCompare(b))
                    .forEach(id => {
                        sorted[id] = result.scenarios[id];
                    });

                const reorderedScenarios = {};
                Object.entries(sorted).forEach(([id, sc]) => {
                    reorderedScenarios[id] = orderScenarioFields(sc);
                });
                result.scenarios = reorderedScenarios;
            }

            return JSON.stringify(result, null, 2);
        }


        // Re-orders one scenario object →  { name, text, options, …rest }
        function orderScenarioFields(sc) {
            const ordered = {};
            ['name', 'text', 'options'].forEach(k => {
                if (sc[k] !== undefined) ordered[k] = sc[k];
            });
            Object.keys(sc).forEach(k => {
                if (!ordered.hasOwnProperty(k)) ordered[k] = sc[k];
            });

            // ----- inside the options array -----
            if (Array.isArray(ordered.options)) {
                ordered.options = ordered.options.map(orderOptionFields);
            }

            return ordered;
        }


        // Re-orders one option object → { text, id, …rest }
        function orderOptionFields(opt) {
            const ordered = {};
            ['text', 'id'].forEach(k => {
                if (opt[k] !== undefined) ordered[k] = opt[k];
            });
            Object.keys(opt).forEach(k => {
                if (!ordered.hasOwnProperty(k)) ordered[k] = opt[k];
            });
            return ordered;
        }


        function hidePresentation() { presControls.classList.add('hidden'); presArea.classList.add('hidden'); presContent.innerHTML = ''; }
        function showStatus(msg, cls = '') { statusMsg.textContent = msg; statusMsg.className = cls; }

        /* ------------------------- SAVE ----------------------------------- */
        uploadBtn.onclick = async () => {
            const id = storyIdInput.value.trim(); const raw = storyJsonArea.value;
            if (!id || !raw) return showStatus('Story ID and JSON required.', 'text-red-600');
            let obj; try { obj = JSON.parse(raw); } catch { return showStatus('Invalid JSON.', 'text-red-600'); }
            const ref = doc(db, 'stories', id); const snap = await getDoc(ref);
            const save = { ...obj, updatedAt: serverTimestamp(), createdAt: snap.exists() ? snap.data().createdAt : serverTimestamp() };
            await setDoc(ref, save);
            showStatus(`Story "${id}" saved.`, 'text-green-600'); loadStories();
        };
        /* ------------------------- DELETE ----------------------------------- */
        // ---------- Delete Story ----------
        deleteBtn.onclick = async () => {
            const id = storySelect.value.trim();
            if (!id) {
                alert('Please select a story first.');
                return;
            }

            // 1) Confirm with the user
            const sure = confirm(`Delete story "${id}" permanently?`);
            if (!sure) return;

            try {
                // 2) Remove from Firestore
                await deleteDoc(doc(db, 'stories', id));

                // 3) Update UI + feedback
                showStatus(`Story "${id}" deleted.`, 'text-green-600');

                // Clear form
                storyIdInput.value = '';
                storyJsonArea.value = '';
                storySelect.value = '';

                // Hide presentation pane
                hidePresentation();

                // Refresh the drop-down list
                loadStories();
            } catch (e) {
                showStatus(e.message, 'text-red-600');
            }
        };

        /* ----------------------- PREVIEW STORY -------------------------------------*/

        previewBtn.onclick = () => {
            const rawJson = storyJsonArea.value.trim();
            if (!rawJson) {
                alert('Nothing to preview – please load or create a story JSON first.');
                return;
            }
            // URL-encode and open in new tab
            const encoded = encodeURIComponent(rawJson);
            const previewUrl = `story.html?preview=1&data=${encoded}`;
            window.open(previewUrl, '_blank');
        };

        /* ------------------------- CREATE STORY ----------------------------------- */

        // 1. Toggle the form when “Create New Story” is clicked
        createBtn.onclick = () => {
            if (!storySelect.value) {
                alert('Please select an existing story first – it will be used as an example.');
                return;
            }
            createForm.classList.toggle('hidden');
        };


        submitBtn.onclick = async () => {
            // 1️⃣ Make sure an example story is loaded
            if (!storySelect.value) {
                alert('Please select an existing story to use as an example first.');
                return;
            }

            // 2️⃣ Gather inputs
            const subject = subjectInput.value.trim();
            const instr = instrInput.value.trim();
            const exampleJson = storyJsonArea.value;

            // 3️⃣ Build the LLM prompt (use your template here)
            const prompt = `
                                        You are an assistant that generates interactive case-study stories for medical students, helping them learn the correct treatment pathways.
                                        These stories are represented as JSON following our established schema. Here is an example of an existing story (for reference):
                                        \`\`\`
                                        ${exampleJson}
                                        \`\`\`

                                        Using this schema:
1. **Top-level keys** in order:
                           - title (string)
                           - status (string - initial value: draft)
                           - createdAt, updatedAt (timestamp objects)
                           - scenarios (object of scenario-objects)
                           - summary (object with a “points” array)
                           - quiz (object with a “choices” array)

2. **Each scenario** must have keys in this order:
                           - name (string)
                           - text (string)
                           - pathResult (string. one of the values:
                                undetermined - for paths still in progress,
                                success - for paths ending positively,
                                failure - for paths ending negatively)
                           - options (array of option-objects)

3. **Each option** must have:
                           - text (string)
                           - id (string matching one of the scenario keys)
                           - drugName(string, the name of the chosen drug if this option represents a drug choice, starts with a capital letter)


5. **Mermaid compliance**:
                           - Scenario IDs become graph node IDs.
                           - Option texts must be short, single-line labels without unsupported Unicode.

** There always must be an OPT0 scenario which is the starting point**
** Scenario with pathResult=success must always have an empty options array**
** Scenario with pathResult=failure must always have one option with the text Back which is getting the user back to the scenario he came from**
---

**Now** create a **brand new interactive case-study story JSON** with:
- **Title** based on: Subject: ${subject} and on Additional instructions (if any): ${instr || 'none'}

                                        Output **only** the new story’s JSON, ready for Mermaid rendering.
                                          `.trim();

            // 4️⃣ UI feedback
            spinner.classList.remove('hidden');
            submitBtn.disabled = true;
            newStoryStatus.textContent = 'Generating new story…';
            newStoryStatus.className = 'text-gray-700';

            try {
                // 5️⃣ Call your serverless function
                const res = await fetch(chatEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                // 6️⃣ Read the body exactly once as text
                const raw = await res.text();

                // 7️⃣ Try to parse JSON out of it
                let data;
                try {
                    data = JSON.parse(raw);
                } catch {
                    // if it wasn’t JSON, show the whole response
                    throw new Error(`Invalid JSON response:\n${raw}`);
                }

                // 8️⃣ Check for HTTP errors
                if (!res.ok) {
                    const msg = data.error || JSON.stringify(data);
                    throw new Error(`API error ${res.status}: ${msg}\n${data.stack || ''}`);
                }

                // 9️⃣ Pull out your `reply`
                const reply = data.reply;


                // 6️⃣ Load into the textarea & re-render
                // Clean up code fences, if present
                let cleaned = reply.trim();
                if (cleaned.startsWith('```')) {
                    cleaned = cleaned
                        .replace(/^```(?:json)?\s*/, '')  // remove opening ``` or ```json
                        .replace(/```$/, '');             // remove trailing ```
                }
                // put JSON in textarea
                storyJsonArea.value = cleaned;
                // derive a slug from the new title and set it as the Story ID
                try {
                    const newStory = JSON.parse(cleaned);
                    const title = newStory.title || '';
                    // lowercase, then replace every non-a–z or 0–9 with a hyphen
                    const slug = title
                        .toLowerCase()
                        .replace(/[^a-z0-9]/g, '-')
                        // collapse multiple hyphens
                        .replace(/-+/g, '-')
                        // trim hyphens off ends
                        .replace(/(^-|-$)/g, '');
                    storyIdInput.value = slug;
                } catch (e) {
                    console.warn('Could not parse new story JSON for title → ID slug', e);
                }

                setupPresentation();

                // 7️⃣ Hide form + success message
                createForm.classList.add('hidden');
                newStoryStatus.textContent = '✅ New story loaded!';
                newStoryStatus.className = 'text-green-600';
            } catch (e) {
                newStoryStatus.textContent = `Error: ${e.message}`;
                newStoryStatus.className = 'text-red-600 mt-2';
            } finally {
                spinner.classList.add('hidden');
                submitBtn.disabled = false;
            }
        };


    </script>
</body>
</html>
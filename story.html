<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Story Engine</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* simple shake keyframes */
        @keyframes shake {
            0%,100% {
                transform: translateX(0);
            }

            10%,30%,50%,70%,90% {
                transform: translateX(-5px);
            }

            20%,40%,60%,80% {
                transform: translateX(5px);
            }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Custom button centering class */
        .story-button-center {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
        }
        
        /* More specific selector */
        button.story-button-center {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
        }
        
        /* Even more specific */
        button.flex-1.bg-blue-500.hover\:bg-blue-600.text-white.py-2.rounded.story-button-center {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
        }
        /* Responsive resource panel layout */
        @media (min-width: 1024px) {
            .story-app-layout {
                display: flex;
                flex-direction: row;
                align-items: flex-start; /* top align */
                gap: 2rem;
            }
            .story-app-layout > .main-col {
                flex: 2 1 0%;
                min-width: 0; /* prevent overflow shrink bugs */
            }
            .story-app-layout > .resource-panel {
                flex: 1 1 280px;
                max-width: 360px;       /* tune */
                position: sticky;
                top: 0;                 /* align with top of viewport */
                margin-top: 0;
            }
        }
        @media (max-width: 1023px) {
            .story-app-layout {
                display: block;
            }
            .resource-panel {
                margin: 0 0 2rem 0;
                position: static;
            }
        }
    </style>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 lg:px-8 py-6 max-w-7xl">
        <!-- Header with back-link and logo -->
        <div class="flex justify-between items-center mb-4">
            <a href="index.html" class="text-blue-600 hover:underline">← Back to Stories</a>
            <img src="images/logo.png" alt="Levo Logo" class="w-24 md:w-32 h-auto" />
        </div>

        <div id="app" class="space-y-6"></div>
    </div>

    <!-- Drug Info Modal -->
    <div id="modal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-4 w-11/12 max-w-md">
            <div class="flex items-center mb-2">
                <span id="modal-title" class="flex flex-1 text-lg font-semibold text-blue-800"></span>
                <button id="modal-close" class="text-gray-500 hover:text-gray-800">✕</button>
            </div>
            <div id="modal-content" class="text-sm text-gray-800 max-h-60 overflow-y-auto"></div>
        </div>
    </div>

    <script type="module">
        console.log('[Story Engine] Module loading...');
        
        const INTRO_ENABLED = true;  // set to false to skip intro and go straight to the first scenario

        import {
            db, collection, doc, getDoc, getDocs, query, where, orderBy
        } from './js/firebase-init.js';

        import { renderMarkupToHtmlString } from './js/codeTagUtils.js';
        import { transformReflectTokens, activateReflect } from './js/reflectUtils.js';
        import { renderResourcePanel } from './js/resourceView.js';

        // load drug info ui-fields
        // right after you initialize Firestore…
        let drugSummaryFields = [], drugExtendedFields = [];

        (async () => {
            // Summary
            const sumQ = query(
                collection(db, 'ui-fields'),
                where('ui_part', '==', 'drug'),
                where('type', '==', 'Summary'),
                orderBy('order')
            );
            const sumSnap = await getDocs(sumQ);
            drugSummaryFields = sumSnap.docs.map(d => d.data());

            // Extended
            const extQ = query(
                collection(db, 'ui-fields'),
                where('ui_part', '==', 'drug'),
                where('type', '==', 'Extended'),
                orderBy('order')
            );
            const extSnap = await getDocs(extQ);
            drugExtendedFields = extSnap.docs.map(d => d.data());
        })();



        const drugCache = new Map();                 // name → { …profile… } | null

        async function fetchDrug(name) {
            if (drugCache.has(name)) return drugCache.get(name);
            try {
                const snap = await getDoc(doc(db, 'drugs', name));
                const data = snap.exists() ? snap.data() : null;

                drugCache.set(name, data);
                return data;
            } catch (e) {
                console.error('Drug fetch failed', e);
                drugCache.set(name, null);
                return null;
            }
        }


        (async function () {
            console.log('[Story Engine] Script starting...');
            
            try {
                // 1) Determine storyId from URL
                const params = new URLSearchParams(window.location.search);
                console.log('[Story Engine] URL params:', params.toString());
                let data;
                if (params.get('preview') === '1') {
                    console.log('[Story Engine] Preview mode detected');
                    // —— PREVIEW MODE ——
                    const dataParam = localStorage.getItem('preview-story-data');
                    console.log('[Story Engine] Preview data from localStorage:', dataParam ? 'exists' : 'missing');
                    if (!dataParam) {
                        document.getElementById('app').innerHTML =
                            `<div class="text-red-600">No preview data found. Please try previewing again.</div>`;
                        return;
                    }
                    // only now parse
                    try {
                        data = JSON.parse(dataParam);
                        console.log('[Story Engine] Preview data parsed successfully');
                        // Clean up localStorage after successful load
                        localStorage.removeItem('preview-story-data');
                    } catch (e) {
                        console.error('[Story Engine] Preview JSON parse error:', e);
                        document.getElementById('app').innerHTML =
                            `<div class="text-red-600">Preview JSON is invalid: ${e.message}</div>`;
                        return;
                    }
                } else {
                    console.log('[Story Engine] Normal mode detected');
                    // —— NORMAL MODE ——
                    const storyId = params.get('story') || 'no story';
                    console.log('[Story Engine] Story ID:', storyId);
                    const snap = await getDoc(doc(db, 'stories', storyId));
                    if (!snap.exists()) {
                        document.getElementById('app').innerHTML =
                            `<div class="text-red-600">Story "${storyId}" not found in Firestore.</div>`;
                        return;
                    }
                    data = snap.data();
                    console.log('[Story Engine] Story data loaded from Firestore');
                }
            
            // 2) Get language direction and apply it
            let storyDirection = 'ltr'; // default
            console.log('[Story Engine] Story language field:', data.language);
            
            if (data.language) {
                try {
                    console.log('[Story Engine] Fetching language direction for:', data.language);
                    const langQuery = query(
                        collection(db, 'languages'),
                        where('code', '==', data.language),
                        where('isActive', '==', true)
                    );
                    const langSnap = await getDocs(langQuery);
                    console.log('[Story Engine] Language query result:', langSnap.size, 'documents found');
                    
                    if (!langSnap.empty) {
                        const langData = langSnap.docs[0].data();
                        console.log('[Story Engine] Language data:', langData);
                        storyDirection = langData.direction || 'ltr';
                        console.log('[Story Engine] Direction from Firestore:', langData.direction);
                    } else {
                        console.warn('[Story Engine] No language document found for code:', data.language);
                        // Fallback: Force RTL for Hebrew language codes
                        if (data.language === 'he' || data.language === 'iw' || data.language === 'he-IL') {
                            console.log('[Story Engine] Using fallback RTL for Hebrew language');
                            storyDirection = 'rtl';
                        }
                    }
                } catch (error) {
                    console.error('[Story Engine] Error fetching language direction:', error);
                    // Fallback: Force RTL for Hebrew language codes
                    if (data.language === 'he' || data.language === 'iw' || data.language === 'he-IL') {
                        console.log('[Story Engine] Using fallback RTL for Hebrew language after error');
                        storyDirection = 'rtl';
                    }
                }
            } else {
                console.warn('[Story Engine] No language field found in story data');
            }
            
            // Apply language direction to the document
            document.documentElement.dir = storyDirection;
            document.documentElement.lang = data.language || 'en';
            
            console.log(`[Story Engine] Final settings - Language: ${data.language}, Direction: ${storyDirection}`);
            console.log('[Story Engine] Document dir attribute:', document.documentElement.dir);
            console.log('[Story Engine] Document lang attribute:', document.documentElement.lang);
            
            const scenarios = data.scenarios;

            const drugNames = Array.from(
                Object.values(data.scenarios || {})       // turn the object into an array
                    .reduce((acc, sc) => {
                        (sc.options || []).forEach(o => {
                            if (o.drugName) acc.add(o.drugName);   // Set keeps them unique
                        });
                        return acc;
                    }, new Set())                       // ← Set for uniqueness
            );

            /* --- canonical map:  "ciprofloxacin" → "Ciprofloxacin" --- */
            const drugMap = new Map(drugNames.map(n => [n.toLowerCase(), n]));
            const drugSet = new Set(drugMap.keys());          // fast membership test

            const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const DRUG_REGEX =
                new RegExp(`\\b(${drugNames.map(esc).join('|')})\\b`, 'gi'); // still global / i

            const quiz = data.quiz;
            const summary = data.summary;

            async function showDrugInfo(name) {
                const info = await fetchDrug(name);
                if (!info) {
                    alert(`Drug “${name}” is not yet in the database.`);
                    return;
                }
                // reuse your existing modal renderer
                showModal(name, info);
            }


            // 3) Setup state & SVG utility
            let current = 'OPT0', inQuiz = false, answers = {};
            function svg(html) {
                const t = document.createElement('template');
                t.innerHTML = html.trim();
                return t.content.firstChild;
            }
            const InfoSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-1 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2.25c5.385 0 9.75 4.365 9.75 9.75S17.385 21.75 12 21.75 2.25 17.385 2.25 12 6.615 2.25 12 2.25z"/></svg>`;
            const ShieldSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-600 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m1-2a9 9 0 11-8 0v5a2 2 0 002 2h4a2 2 0 010 0V6z"/></svg>`;
            // at the top of your <script> (right after your other SVG constants)
            const BackIcon = `
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
                </svg>
                `;
            const ExtendedIcon = `
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                </svg>
                `;

            // Modal controls
            const modal = document.getElementById('modal');
            document.getElementById('modal-close').onclick = () => modal.classList.add('hidden');

            // 1) Replace your existing showModal with this:
            function showModal(title, info) {
                // build the summary list
                const listItems = drugSummaryFields
                    .map(f => `<li><strong>${f.name}:</strong> ${info[f.data_field_id] ?? ''}</li>`)
                    .join('');

                // insert into modal
                modal.querySelector('#modal-title').textContent = title + ' Summary';
                modal.querySelector('#modal-title').style.direction = storyDirection;
                modal.querySelector('#modal-title').style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                
                modal.querySelector('#modal-content').innerHTML = `
    <ul class="list-disc ml-5 mb-4" style="direction: ${storyDirection}; text-align: ${storyDirection === 'rtl' ? 'right' : 'left'};">${listItems}</ul>
    <button id="show-extended-btn"
            class="mt-4 float-right text-blue-800 bg-transparent px-3 py-1 rounded"
            style="direction: ${storyDirection}; text-align: ${storyDirection === 'rtl' ? 'right' : 'left'};">
      ${ExtendedIcon}
    </button>
  `;
                // wire up the new button
                modal.querySelector('#show-extended-btn')
                    .addEventListener('click', () => renderModal('Extended', title, info));

                modal.classList.remove('hidden');
            }

            function renderModal(type, title, info) {
                const fields = type === 'Extended'
                    ? drugExtendedFields
                    : drugSummaryFields;

                const listItems = fields
                    .map(f => `<li><strong>${f.name}:</strong> ${info[f.data_field_id] ?? ''}</li>`)
                    .join('');

                // button text and handler toggle
                const toggleText = type === 'Extended' ? 'Back to Summary' : 'Show Extended Info';
                const nextType = type === 'Extended' ? 'Summary' : 'Extended';

                modal.querySelector('#modal-title').textContent = title + ' ' + type;
                modal.querySelector('#modal-title').style.direction = storyDirection;
                modal.querySelector('#modal-title').style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                
                modal.querySelector('#modal-content').innerHTML =
                    `<ul class="list-disc ml-5 mb-4" style="direction: ${storyDirection}; text-align: ${storyDirection === 'rtl' ? 'right' : 'left'};">${listItems}</ul>
                    <button id="toggle-info-btn"
                            class="mt-4 float-right text-blue-800 bg-transparent px-3 py-1 rounded"
                            style="direction: ${storyDirection}; text-align: ${storyDirection === 'rtl' ? 'right' : 'left'};">
                      ${type === 'Extended' ? BackIcon : ExtendedIcon}
                    </button>
                  `;
                modal.querySelector('#toggle-info-btn')
                    .addEventListener('click', () => renderModal(nextType, title, info));

                modal.classList.remove('hidden');
            }

            // Add this utility function after SVG/icon constants
            function renderResources(resourceIds) {
                if (!data.resources) return null;
                let resourcesToShow = [];
                if (Array.isArray(resourceIds)) {
                    resourcesToShow = resourceIds.map(id => data.resources[id]).filter(Boolean);
                } else {
                    resourcesToShow = Object.values(data.resources);
                }
                if (!resourcesToShow.length) return null;
                const container = document.createElement('div');
                container.className = 'mb-4';
                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold mb-2 text-blue-700';
                title.textContent = 'Resources';
                container.append(title);
                resourcesToShow.forEach(res => {
                    const row = document.createElement('div');
                    row.className = 'flex items-start mb-2';
                    const main = document.createElement('div');
                    main.className = 'flex-1';
                    const name = document.createElement('span');
                    name.className = 'font-semibold';
                    name.textContent = res.displayName || res.url || 'Resource';
                    main.append(name);
                    if (res.description) {
                        const desc = document.createElement('span');
                        desc.className = 'ml-2 text-gray-600';
                        desc.textContent = res.description;
                        main.append(desc);
                    }
                    row.append(main);
                    if (res.url) {
                        const btn = document.createElement('a');
                        btn.href = res.url;
                        btn.target = '_blank';
                        btn.className = 'ml-2 text-blue-600 underline';
                        btn.textContent = 'Open';
                        row.append(btn);
                    }
                    if (res.importance) {
                        const badge = document.createElement('span');
                        badge.className = 'ml-2 px-2 py-0.5 rounded text-xs bg-yellow-100 text-yellow-800 border border-yellow-300';
                        badge.textContent = res.importance;
                        row.append(badge);
                    }
                    container.append(row);
                });
                return container;
            }

            // Render story
            function renderStory() {
                inQuiz = false;
                const app = document.getElementById('app');
                app.innerHTML = '';
                const sc = scenarios[current];
                // Story text card
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded shadow text-lg whitespace-pre-wrap';
                card.style.direction = storyDirection;
                card.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                if (sc.pathResult === 'failure') {
                    card.classList.add('bg-red-50', 'border', 'border-red-400');
                    card.classList.add('shake');
                    const banner = document.createElement('div');
                    banner.className = 'flex items-center bg-red-500 text-white px-4 py-2 rounded-t';
                    banner.style.direction = storyDirection;
                    banner.innerHTML = `<span class=\"text-xl mr-2\">❌</span><strong>Incorrect choice</strong>`;
                    card.prepend(banner);
                }
                // --- Enhanced scenario text rendering with reflect support ---
                console.log('Scenario text (raw):', sc.text);
                const reflectToken = '<<reflect>>';
                const scenarioText = sc.text || '';
                const scenarioId = sc.id || current;
                const mode = 'gated';
                // Split on the reflect token
                const parts = scenarioText.split(reflectToken);
                let html = '';
                for (let i = 0; i < parts.length; i++) {
                    html += renderMarkupToHtmlString(parts[i]);
                    if (i < parts.length - 1) {
                        // Insert the reflect widget after each token (except the last part)
                        html += transformReflectTokens(reflectToken, { scenarioId, mode });
                    }
                }
                console.log('Final HTML before insert:', html);
                // Ensure paragraph is defined
                const paragraph = document.createElement('div');
                paragraph.className = 'mb-4 whitespace-pre-wrap';
                paragraph.style.direction = storyDirection;
                paragraph.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                paragraph.innerHTML = html;
                // Activate reflect widget if present
                const reflectWidget = paragraph.querySelector('.reflect-cue[data-reflect]');
                if (reflectWidget) {
                    console.log('Reflect widget found, activating...');
                } else {
                    console.log('No reflect widget found in paragraph.');
                }
                activateReflect(paragraph, {
                    scenarioId,
                    mode,
                    optionSelector: '[data-option-id]'
                });
                card.append(paragraph);
                // --- Add scenario-specific resources if present ---
                let scenarioResourcesEl = null;
                if (Array.isArray(sc.resourceIds) && sc.resourceIds.length && data.resources) {
                    const resources = sc.resourceIds.map(id => data.resources[id]).filter(Boolean);
                    if (resources.length) scenarioResourcesEl = renderResourcePanel(resources, { direction: storyDirection });
                }
                // --- Restore options rendering ---
                const opts = document.createElement('div');
                opts.className = 'flex flex-col space-y-3';
                opts.style.direction = storyDirection;
                const startQuiz = sc.pathResult === 'success';
                sc.options.forEach(o => {
                    const row = document.createElement('div');
                    row.className = 'flex';
                    row.style.direction = storyDirection;
                    // option button
                    const b = document.createElement('button');
                    b.className = 'flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded story-button-center';
                    b.style.direction = storyDirection;
                    b.innerHTML = renderMarkupToHtmlString(o.text || '');
                    b.setAttribute('data-option-id', o.id);
                    b.onclick = () => { current = o.id; renderStory(); };
                    row.append(b);
                    opts.append(row);
                });
                if (startQuiz && quiz) {
                    const qbtn = document.createElement('button');
                    qbtn.textContent = 'Take Quiz';
                    qbtn.className = 'mt-4 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded story-button-center';
                    qbtn.style.direction = storyDirection;
                    qbtn.onclick = renderQuiz;
                    opts.append(qbtn);
                }
                card.append(opts);

                const mainWrap = document.createElement('div');
                mainWrap.className = 'main-col';
                mainWrap.append(card);

                // Layout: resources panel + main content
                const layout = document.createElement('div');
                layout.className = 'story-app-layout';
                layout.append(mainWrap);
                if (scenarioResourcesEl) 
                    layout.append(scenarioResourcesEl);
                
                app.append(layout);
                // Activate reflection widget if present
                // activateReflect(paragraph, {
                //     scenarioId: current,
                //     mode: 'gated',
                //     optionSelector: '[data-option-id]',
                // });
            }


            // Render quiz
            function renderQuiz() {
                inQuiz = true; answers = {};
                const app = document.getElementById('app');
                app.innerHTML = '';
                app.style.direction = storyDirection;
                app.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                // --- Add global resources if present ---
                const resourcesEl = data.resources ? renderResourcePanel(Object.values(data.resources), { direction: storyDirection }) : null;
                const form = document.createElement('form');
                form.className = 'space-y-6 bg-white p-6 rounded shadow';
                form.style.direction = storyDirection;
                form.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';

                quiz.choices.forEach(q => {
                    const block = document.createElement('div');
                    block.style.direction = storyDirection;
                    const qel = document.createElement('p');
                    qel.className = 'font-semibold';
                    qel.style.direction = storyDirection;
                    qel.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                    qel.innerHTML = renderMarkupToHtmlString(q.question || '');
                    block.append(qel);
                    q.options.forEach(opt => {
                        const label = document.createElement('label');
                        label.className = 'inline-flex items-center mr-4';
                        label.style.direction = storyDirection;
                        const inp = document.createElement('input');
                        inp.type = 'radio'; inp.name = q.id; inp.value = opt; inp.className = 'mr-2';
                        label.append(inp);
                        const optSpan = document.createElement('span');
                        optSpan.innerHTML = renderMarkupToHtmlString(opt);
                        label.append(optSpan);
                        block.append(label);
                    });
                    form.append(block);
                });

                const submit = document.createElement('button');
                submit.type = 'submit';
                submit.className = 'bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded story-button-center';
                submit.style.direction = storyDirection;
                submit.textContent = 'Submit Quiz';
                form.append(submit);

                form.onsubmit = e => {
                    e.preventDefault();
                    quiz.choices.forEach(q => {
                        answers[q.id] = form[q.id].value;
                    });
                    renderQuizResults();
                };
                // Layout: resources panel + main content
                const layout = document.createElement('div');
                layout.className = 'story-app-layout';

                const mainWrap = document.createElement('div');
                mainWrap.className = 'main-col';
                mainWrap.append(form);
                
                layout.append(mainWrap);
                if (resourcesEl) layout.append(resourcesEl);
                
                app.append(layout);
            }

            // Render quiz results
            function renderQuizResults() {
                const app = document.getElementById('app');
                app.innerHTML = '';
                app.style.direction = storyDirection;
                app.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                
                quiz.choices.forEach(q => {
                    const block = document.createElement('div'); 
                    block.className = 'mb-4';
                    block.style.direction = storyDirection;
                    const qel = document.createElement('p'); 
                    qel.className = 'font-semibold';
                    qel.style.direction = storyDirection;
                    qel.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                    qel.innerHTML = renderMarkupToHtmlString(q.question || '');
                    block.append(qel);
                    const user = answers[q.id], correct = q.correct;
                    const res = document.createElement('p');
                    res.style.direction = storyDirection;
                    res.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                    if (user === correct) {
                        res.textContent = `✔ Correct (${user})`; res.className = 'text-green-600';
                    } else {
                        res.textContent = `✖ You chose "${user || '—'}", correct is "${correct}"`; res.className = 'text-red-600';
                    }
                    block.append(res); app.append(block);
                });
                if (summary) {
                    const sb = document.createElement('button');
                    sb.textContent = 'Show Summary';
                    sb.className = 'mt-2 bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded story-button-center';
                    sb.style.direction = storyDirection;
                    sb.onclick = renderSummary;
                    app.append(sb);
                }
            }

            // Render summary
            function renderSummary() {
                const app = document.getElementById('app');
                app.innerHTML = '';
                app.style.direction = storyDirection;
                app.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                // --- Add global resources if present ---
                const resourcesEl = data.resources ? renderResourcePanel(Object.values(data.resources), { direction: storyDirection }) : null;
                
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded shadow space-y-2';
                card.style.direction = storyDirection;
                card.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                
                const h = document.createElement('h2');
                h.className = 'text-xl font-semibold'; 
                h.style.direction = storyDirection;
                h.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                h.textContent = 'Key Summary Points';
                card.append(h);
                summary.points.forEach(pt => {
                    const p = document.createElement('p');
                    p.className = 'flex items-start';
                    p.style.direction = storyDirection;
                    p.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';
                    p.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>${renderMarkupToHtmlString(pt)}`;
                    card.append(p);
                });
                // Layout: resources panel + main content
                const layout = document.createElement('div');
                layout.className = 'story-app-layout';

                const mainWrap = document.createElement('div');
                mainWrap.className = 'main-col';
                mainWrap.append(card);
                
                layout.append(mainWrap);
                if (resourcesEl) layout.append(resourcesEl);
                
                app.append(layout);
            }

            function renderIntro() {
                const app = document.getElementById('app');
                app.innerHTML = '';
                app.style.direction = storyDirection;
                app.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';

                // 1) Story title
                const titleEl = document.createElement('h1');
                titleEl.textContent = data.title;                        // assume you loaded data.title from Firestore
                titleEl.className = 'text-3xl font-bold mb-2';
                titleEl.style.direction = storyDirection;
                titleEl.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';

                // 2) Intro sentence
                const descEl = document.createElement('p');
                descEl.textContent = 'The following antibiotics play a key role in this case study:';
                descEl.className = 'mb-4 text-gray-700';
                descEl.style.direction = storyDirection;
                descEl.style.textAlign = storyDirection === 'rtl' ? 'right' : 'left';

                // --- Add global resources if present ---
                const resourcesEl = data.resources ? renderResourcePanel(Object.values(data.resources), { direction: storyDirection }) : null;

                // Main intro content
                const introContainer = document.createElement('div');
                introContainer.className = 'flex flex-col space-y-3';
                introContainer.style.direction = storyDirection;

                // one "scenario-style" row per drug
                drugNames.forEach(drug => {
                    const row = document.createElement('div');
                    row.className = 'flex';
                    row.style.direction = storyDirection;

                    // big blue button (same as your scenario choice buttons)
                    const drugBtn = document.createElement('button');
                    drugBtn.className = 'flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded story-button-center';
                    drugBtn.style.direction = storyDirection;
                    drugBtn.textContent = drug;
                    drugBtn.onclick = () => showDrugInfo(drug);
                    
                    row.append(drugBtn);

                    introContainer.append(row);
                });

                // finally add your "I'm ready…" start button below
                const startRow = document.createElement('div');
                startRow.className = 'flex';
                startRow.style.direction = storyDirection;

                const startBtn = document.createElement('button');
                startBtn.className = 'flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded story-button-center';
                startBtn.style.direction = storyDirection;
                startBtn.textContent = "I'm ready, let's start";
                startBtn.onclick = () => {
                    renderStory();
                };
                startRow.append(startBtn);

                introContainer.append(startRow);

                // Layout: resources panel + main content
                const layout = document.createElement('div');
                layout.className = 'story-app-layout';
                if (resourcesEl) layout.append(resourcesEl);
                const mainCol = document.createElement('div');
                mainCol.append(titleEl, descEl, introContainer);
                layout.append(mainCol);
                app.append(layout);
            }



            // Kick things off
            if (INTRO_ENABLED) {
                renderIntro();
            } else {
                renderStory();
            }
        } catch (error) {
            console.error('[Story Engine] Fatal error:', error);
            document.getElementById('app').innerHTML = 
                `<div class="text-red-600">Error loading story: ${error.message}</div>`;
        }
        })();
    </script>
</body>
</html>

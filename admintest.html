<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Story Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mermaid -->
    <script src="https://unpkg.com/mermaid@9.4.3/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-2xl font-bold mb-4">üìã Story Admin</h1>

        <!-- AUTH -------------------------------------------------------------- -->
        <div class="mb-6" id="auth-section">
            <button id="sign-in-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Sign in with Google</button>
            <button id="sign-out-btn" class="bg-red-500  hover:bg-red-600 text-white px-4 py-2 rounded ml-2 hidden">Sign out</button>
        </div>

        <!-- MAIN UI ----------------------------------------------------------- -->
        <div id="admin-ui" class="hidden bg-white p-6 rounded shadow space-y-4">
            <!-- 1Ô∏è‚É£ Create-story button + hidden form -->
            <div class="mb-4">
                <button id="create-story-btn"
                        class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded">
                    ‚ûï Create New Story
                </button>

                <!-- hidden until clicked -->
                <div id="create-story-form" class="mt-4 p-4 bg-gray-50 rounded shadow hidden">
                    <div class="mb-3">
                        <label for="new-story-subject" class="block font-semibold mb-1">Story Subject</label>
                        <input id="new-story-subject" type="text"
                               class="border rounded px-3 py-2 w-full"
                               placeholder="e.g. ESBL Case" />
                    </div>
                    <div class="mb-3">
                        <label for="new-story-instr" class="block font-semibold mb-1">
                            Additional Instructions <span class="text-gray-500">(optional)</span>
                        </label>
                        <textarea id="new-story-instr" rows="3"
                                  class="border rounded px-3 py-2 w-full"
                                  placeholder="Give extra context‚Ä¶"></textarea>
                    </div>
                    <button id="new-story-submit"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                        Submit
                    </button>
                </div>
            </div>

            <!-- story select -->
            <div>
                <label for="story-select" class="font-semibold block mb-1">Existing Stories</label>
                <select id="story-select" class="border rounded px-3 py-2 w-full">
                    <option value="">-- Select a story --</option>
                </select>
            </div>

            <!-- story id / json -->
            <div>
                <label for="story-id" class="font-semibold block mb-1">Story ID</label>
                <input id="story-id" type="text" class="border rounded px-3 py-2 w-full" />
            </div>
            <div>
                <label for="story-json" class="font-semibold block mb-1">Story JSON</label>
                <textarea id="story-json" rows="15" class="border rounded px-3 py-2 font-mono w-full text-sm"></textarea>
            </div>

            <div class="flex space-x-2">
                <button id="upload-btn"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    Save Story
                </button>

                <!-- New Delete button -->
                <button id="delete-btn"
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    Delete Story
                </button>
            </div>
            <p id="status-msg" class="mt-2"></p>

            <!-- PRESENTATION CONTROLS -->
            <div id="presentation-controls" class="hidden mt-6">
                <label for="presentation-select" class="font-semibold mr-2">View:</label>
                <select id="presentation-select" class="border rounded px-2 py-1"></select>
            </div>
            <div id="presentation-area" class="hidden bg-white p-4 rounded shadow mt-4 overflow-auto">
                <div id="presentation-content" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, serverTimestamp, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

        /* ----------------------------- ChatGpt -----------------------------*/
        const chatEndpoint = '/api/chat';

        /* ---------------------------- Firebase ---------------------------- */
        const firebaseConfig = {
            apiKey: "AIzaSyClEgpGrVTXT2zQNNDBDg0TNX2F24k6oTg",
            authDomain: "urushka99.firebaseapp.com",
            projectId: "urushka99",
            storageBucket: "urushka99.firebasestorage.app",
            messagingSenderId: "954120822793",
            appId: "1:954120822793:web:6c316b1b178081b56758d8",
            measurementId: "G-5LCB9E7PL9"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        /* ------------------------------ UI -------------------------------- */
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const adminUI = document.getElementById('admin-ui');

        const storySelect = document.getElementById('story-select');
        const storyIdInput = document.getElementById('story-id');
        const storyJsonArea = document.getElementById('story-json');
        const uploadBtn = document.getElementById('upload-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const createBtn = document.getElementById('create-story-btn');
        const createForm = document.getElementById('create-story-form');
        const subjectInput = document.getElementById('new-story-subject');
        const instrInput = document.getElementById('new-story-instr');
        const submitBtn = document.getElementById('new-story-submit');

        const statusMsg = document.getElementById('status-msg');

        const presControls = document.getElementById('presentation-controls');
        const presSelect = document.getElementById('presentation-select');
        const presArea = document.getElementById('presentation-area');
        const presContent = document.getElementById('presentation-content');

        /* ----------------------------- Auth ------------------------------- */
        signInBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => showStatus(e.message, 'text-red-600'));
        signOutBtn.onclick = () => signOut(auth);

        onAuthStateChanged(auth, user => {
            const logged = !!user;
            signInBtn.classList.toggle('hidden', logged);
            signOutBtn.classList.toggle('hidden', !logged);
            adminUI.classList.toggle('hidden', !logged);
            if (logged) loadStories();
        });

        /* --------------------- Firestore helpers -------------------------- */
        async function loadStories() {
            storySelect.innerHTML = '<option value="">-- Select a story --</option>';
            const snap = await getDocs(collection(db, 'stories'));
            snap.forEach(docSnap => {
                const opt = document.createElement('option');
                opt.value = docSnap.id;
                const d = docSnap.data();
                opt.textContent = d.title || d.name || docSnap.id;
                storySelect.append(opt);
            });
        }

        /* --------------------------- UI logic ----------------------------- */
        storySelect.onchange = async () => {
            const id = storySelect.value;
            if (!id) return hidePresentation();
            const snap = await getDoc(doc(db, 'stories', id));
            if (!snap.exists()) return hidePresentation();
            const data = snap.data();
            storyIdInput.value = id;
            storyJsonArea.value = orderKeys(data);
            setupPresentation();
        };

        storyJsonArea.oninput = () => { try { JSON.parse(storyJsonArea.value); } catch { return; } setupPresentation(); };

        /* ------------------------ Presentation ---------------------------- */
        function setupPresentation() {
            let data;
            try { data = JSON.parse(storyJsonArea.value); } catch { return hidePresentation(); }
            presSelect.innerHTML = '';
            const views = [];
            if (data.scenarios) views.push(['graph', 'Graph']);
            if (data.drugInfo) views.push(['drugInfo', 'Drug Info']);
            if (data.quiz) views.push(['quiz', 'Quiz']);
            if (data.summary) views.push(['summary', 'Summary']);
            if (!views.length) return hidePresentation();
            views.forEach(([val, label]) => {
                const o = new Option(label, val);
                presSelect.append(o);
            });
            presControls.classList.remove('hidden');
            presArea.classList.remove('hidden');
            presSelect.onchange = renderPresentation;
            renderPresentation();
        }

        function renderPresentation() {
            let data;
            try { data = JSON.parse(storyJsonArea.value); } catch { return; }
            presContent.innerHTML = '';
            const mode = presSelect.value;
            if (mode === 'graph') renderGraphView(data);
            else if (mode === 'drugInfo') renderDrugInfo(data);
            else if (mode === 'quiz') renderQuiz(data);
            else if (mode === 'summary') renderSummary(data);
        }

        /* -------------------- GRAPH VIEW ------------------------- */
        function renderGraphView(data) {
            // switch between graphic & table views
            const topBar = document.createElement('div');
            topBar.className = 'flex items-center justify-between mb-2';

            const viewSel = document.createElement('select');
            viewSel.className = 'border rounded px-2 py-1';
            viewSel.innerHTML = '<option value="graphic">Graphic</option><option value="table">Table</option>';
            topBar.append(viewSel);
            presContent.append(topBar);

            const holder = document.createElement('div');
            presContent.append(holder);

            viewSel.onchange = () => draw(viewSel.value);
            draw('graphic');

            function draw(kind) {
                holder.innerHTML = '';
                if (kind === 'graphic') {
                    drawGraphic(holder, data);
                } else {
                    drawScenarioTable(holder);
                }
            }

            function drawGraphic(container, d) {
                const nodes = [], edges = [], idMap = {};
                Object.entries(d.scenarios || {}).forEach(([k, s], i) => {
                    idMap[k] = 'n' + i;
                    nodes.push(`${idMap[k]}["${(s.name || '').replace(/"/g, '\\"').replace(/\n/g, ' ')}"]`);
                });
                Object.entries(d.scenarios || {}).forEach(([k, s]) => {
                    const from = idMap[k];
                    (s.options || []).forEach(o => {
                        const to = idMap[o.id || o.next || o.target];
                        if (to) edges.push(`${from} -->|${(o.text || '').replace(/"/g, '\\"').replace(/\n/g, ' ')}| ${to}`);
                    });
                });
                const diagram = ['flowchart LR', ...nodes, ...edges].join('\n');
                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = diagram;
                container.append(div);

                /* Mermaid error output */
                const mermaidError = document.createElement('div');
                mermaidError.className = 'hidden text-red-600 text-sm whitespace-pre-wrap mt-2';
                mermaidError.id = "mermaid-error";
                container.append(mermaidError);

                mermaid.init(undefined, div);

                // display any syntax / parse error inside the page
                mermaid.parseError = (err /* Error object */, hash /* details */) => {

                    mermaidError.textContent =
                        'Mermaid syntax error:\n' + (err.str || err.message || err.toString());

                    mermaidError.classList.remove('hidden');
                };
            }

            function drawScenarioTable(container) {
                const addBtn = document.createElement('button');
                addBtn.textContent = 'Add Scenario';
                addBtn.className = 'mb-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded';
                addBtn.onclick = () => {
                    const full = JSON.parse(storyJsonArea.value);
                    full.scenarios = full.scenarios || {};
                    let idx = 1; while (full.scenarios['NEW' + idx]) idx++;
                    full.scenarios['NEW' + idx] = { name: '', text: '', options: [] };
                    storyJsonArea.value = JSON.stringify(full, null, 2);
                    renderPresentation();
                };
                container.append(addBtn);

                const table = document.createElement('table');
                table.className = 'table-auto w-full border-collapse';
                table.innerHTML = `<thead><tr class='bg-gray-50'>
                                        <th class='border px-2 py-1'>ID</th>
                                        <th class='border px-2 py-1'>Name</th>
                                        <th class='border px-2 py-1'>Text</th>
                                        <th class='border px-2 py-1'>Options (JSON)</th>
                                        <th class='border px-2 py-1'>Remove</th>
                                    </tr></thead>`;
                const tbody = document.createElement('tbody');
                Object.entries(data.scenarios || {}).forEach(([id, sc]) => {
                    const tr = document.createElement('tr');
                    tr.append(tdPlain(id));
                    tr.append(tdInput(sc.name || '', val => updateField(id, 'name', val)));
                    tr.append(tdInput(sc.text || '', val => updateField(id, 'text', val), 'w-96'));
                    tr.append(tdInput(JSON.stringify(sc.options || []), val => {
                        try { updateField(id, 'options', JSON.parse(val)); } catch {/*ignore*/ }
                    }, 'w-64'));
                    const tdRem = document.createElement('td');
                    tdRem.className = 'border px-2 py-1 text-center';
                    const rm = document.createElement('button');
                    rm.textContent = 'üóë';
                    rm.onclick = () => { const full = JSON.parse(storyJsonArea.value); delete full.scenarios[id]; storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); };
                    tdRem.append(rm);
                    tr.append(tdRem);
                    tbody.append(tr);
                });
                table.append(tbody);
                container.append(table);

                function tdPlain(txt) { const td = document.createElement('td'); td.className = 'border px-2 py-1 text-xs break-all'; td.textContent = txt; return td; }
                function tdInput(val, cb, valClass = '') {
                    const td = document.createElement('td'); td.className = `border px-2 py-1 ${valClass}`; const inp = document.createElement('input'); inp.type = 'text'; inp.value = val; inp.className = 'border rounded px-1 py-0.5 w-full'; inp.oninput = () => cb(inp.value); td.append(inp); return td;
                }
                function updateField(sid, key, value) { const full = JSON.parse(storyJsonArea.value); full.scenarios[sid][key] = value; storyJsonArea.value = JSON.stringify(full, null, 2); }
            }
        }

        /* --------------------- OTHER RENDERERS ------------------------------ */
        function renderSummary(data) {
            const ta = document.createElement('textarea');
            ta.className = 'border rounded px-2 py-1 w-full h-32';
            ta.value = (data.summary?.points || []).join('\n');
            ta.oninput = () => { const full = JSON.parse(storyJsonArea.value); full.summary = { points: ta.value.split('\n') }; storyJsonArea.value = JSON.stringify(full, null, 2); };
            presContent.append(ta);
        }

        function renderQuiz(data) {
            const add = document.createElement('button'); add.textContent = 'Add Question'; add.className = 'mb-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded';
            add.onclick = () => { const full = JSON.parse(storyJsonArea.value); full.quiz = full.quiz || { choices: [] }; full.quiz.choices.push({ id: `Q${full.quiz.choices.length + 1}`, question: '', options: [], correct: '' }); storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); };
            presContent.append(add);
            const table = document.createElement('table'); table.className = 'table-auto w-full border-collapse'; table.innerHTML = `<thead><tr class='bg-gray-50'><th class='border px-2 py-1'>#</th><th class='border px-2 py-1'>ID</th><th class='border px-2 py-1'>Question</th><th class='border px-2 py-1'>Options (comma)</th><th class='border px-2 py-1'>Correct</th><th class='border px-2 py-1'>Remove</th></tr></thead>`;
            const tbody = document.createElement('tbody');
            (data.quiz?.choices || []).forEach((c, i) => {
                const tr = document.createElement('tr');
                tr.append(tdPlain(i + 1));
                tr.append(tdInput(c.id || '', v => update(i, 'id', v)));
                tr.append(tdInput(c.question || '', v => update(i, 'question', v), 'w-64'));
                tr.append(tdInput((c.options || []).join(', '), v => update(i, 'options', v.split(',').map(s => s.trim()).filter(Boolean)), 'w-64'));
                tr.append(tdInput(c.correct || '', v => update(i, 'correct', v)));
                const td = document.createElement('td'); td.className = 'border px-2 py-1 text-center';
                const rm = document.createElement('button'); rm.textContent = 'üóë'; rm.onclick = () => { const full = JSON.parse(storyJsonArea.value); full.quiz.choices.splice(i, 1); storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); }; td.append(rm); tr.append(td);
                tbody.append(tr);
            });
            table.append(tbody); presContent.append(table);
            function tdPlain(t) { const td = document.createElement('td'); td.className = 'border px-2 py-1'; td.textContent = t; return td; }
            function tdInput(v, cb, cls = '') { const td = document.createElement('td'); td.className = `border px-2 py-1 ${cls}`; const inp = document.createElement('input'); inp.type = 'text'; inp.value = v; inp.className = 'border rounded px-1 py-0.5 w-full'; inp.oninput = () => cb(inp.value); td.append(inp); return td; }
            function update(i, k, v) { const full = JSON.parse(storyJsonArea.value); full.quiz.choices[i][k] = v; storyJsonArea.value = JSON.stringify(full, null, 2); }
        }

        function renderDrugInfo(data) {
            const add = document.createElement('button'); add.textContent = 'Add Drug'; add.className = 'mb-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded';
            add.onclick = () => { const full = JSON.parse(storyJsonArea.value); full.drugInfo = full.drugInfo || {}; let n = 1; while (full.drugInfo['Drug' + n]) n++; full.drugInfo['Drug' + n] = { Family: '', PK: '', Spectrum: '', Toxicities: '' }; storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); };
            presContent.append(add);
            const table = document.createElement('table'); table.className = 'table-auto w-full border-collapse'; table.innerHTML = `<thead><tr class='bg-gray-50'><th class='border px-2 py-1'>Name</th><th class='border px-2 py-1'>Family</th><th class='border px-2 py-1'>PK</th><th class='border px-2 py-1'>Spectrum</th><th class='border px-2 py-1'>Toxicities</th><th class='border px-2 py-1'>Remove</th></tr></thead>`;
            const tbody = document.createElement('tbody');
            Object.entries(data.drugInfo || {}).forEach(([name, info]) => {
                const tr = document.createElement('tr');
                tr.append(tdInput(name, v => renameDrug(name, v)));
                ['Family', 'PK', 'Spectrum', 'Toxicities'].forEach(f => tr.append(tdInput(info[f] || '', v => updateDrug(name, f, v))));
                const tdR = document.createElement('td'); tdR.className = 'border px-2 py-1 text-center'; const rm = document.createElement('button'); rm.textContent = 'üóë'; rm.onclick = () => { const full = JSON.parse(storyJsonArea.value); delete full.drugInfo[name]; storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); }; tdR.append(rm); tr.append(tdR);
                tbody.append(tr);
            }); table.append(tbody); presContent.append(table);
            function tdInput(v, cb) { const td = document.createElement('td'); td.className = 'border px-2 py-1'; const inp = document.createElement('input'); inp.type = 'text'; inp.value = v; inp.className = 'border rounded px-1 py-0.5 w-full'; inp.oninput = () => cb(inp.value); td.append(inp); return td; }
            function renameDrug(oldN, newN) { if (!newN || oldN === newN) return; const full = JSON.parse(storyJsonArea.value); if (full.drugInfo[newN]) return; full.drugInfo[newN] = { ...full.drugInfo[oldN] }; delete full.drugInfo[oldN]; storyJsonArea.value = JSON.stringify(full, null, 2); renderPresentation(); }
            function updateDrug(n, f, val) { const full = JSON.parse(storyJsonArea.value); full.drugInfo[n][f] = val; storyJsonArea.value = JSON.stringify(full, null, 2); }
        }

        /* ------------------------- UTILITIES ------------------------------- */
        function orderKeys(data) {
            // ---------- top-level ----------
            const topOrder = ['title', 'createdAt', 'updatedAt',
                'scenarios', 'drugInfo', 'summary', 'quiz'];

            const result = {};
            topOrder.forEach(k => { if (data[k] !== undefined) result[k] = data[k]; });
            Object.keys(data).forEach(k => { if (!result.hasOwnProperty(k)) result[k] = data[k]; });

            // ---------- per-scenario ----------
            if (result.scenarios) {
                const reorderedScenarios = {};
                Object.entries(result.scenarios).forEach(([id, sc]) => {
                    reorderedScenarios[id] = orderScenarioFields(sc);
                });
                result.scenarios = reorderedScenarios;
            }

            return JSON.stringify(result, null, 2);
        }


        // Re-orders one scenario object ‚Üí  { name, text, options, ‚Ä¶rest }
        function orderScenarioFields(sc) {
            const ordered = {};
            ['name', 'text', 'options'].forEach(k => {
                if (sc[k] !== undefined) ordered[k] = sc[k];
            });
            Object.keys(sc).forEach(k => {
                if (!ordered.hasOwnProperty(k)) ordered[k] = sc[k];
            });

            // ----- inside the options array -----
            if (Array.isArray(ordered.options)) {
                ordered.options = ordered.options.map(orderOptionFields);
            }

            return ordered;
        }


        // Re-orders one option object ‚Üí { text, id, ‚Ä¶rest }
        function orderOptionFields(opt) {
            const ordered = {};
            ['text', 'id'].forEach(k => {
                if (opt[k] !== undefined) ordered[k] = opt[k];
            });
            Object.keys(opt).forEach(k => {
                if (!ordered.hasOwnProperty(k)) ordered[k] = opt[k];
            });
            return ordered;
        }


        function hidePresentation() { presControls.classList.add('hidden'); presArea.classList.add('hidden'); presContent.innerHTML = ''; }
        function showStatus(msg, cls = '') { statusMsg.textContent = msg; statusMsg.className = cls; }

        /* ------------------------- SAVE ----------------------------------- */
        uploadBtn.onclick = async () => {
            const id = storyIdInput.value.trim(); const raw = storyJsonArea.value;
            if (!id || !raw) return showStatus('Story ID and JSON required.', 'text-red-600');
            let obj; try { obj = JSON.parse(raw); } catch { return showStatus('Invalid JSON.', 'text-red-600'); }
            const ref = doc(db, 'stories', id); const snap = await getDoc(ref);
            const save = { ...obj, updatedAt: serverTimestamp(), createdAt: snap.exists() ? snap.data().createdAt : serverTimestamp() };
            await setDoc(ref, save);
            showStatus(`Story "${id}" saved.`, 'text-green-600'); loadStories();
        };
        /* ------------------------- DELETE ----------------------------------- */
        // ---------- Delete Story ----------
        deleteBtn.onclick = async () => {
            const id = storySelect.value.trim();
            if (!id) {
                alert('Please select a story first.');
                return;
            }

            // 1) Confirm with the user
            const sure = confirm(`Delete story "${id}" permanently?`);
            if (!sure) return;

            try {
                // 2) Remove from Firestore
                await deleteDoc(doc(db, 'stories', id));

                // 3) Update UI + feedback
                showStatus(`Story "${id}" deleted.`, 'text-green-600');

                // Clear form
                storyIdInput.value = '';
                storyJsonArea.value = '';
                storySelect.value = '';

                // Hide presentation pane
                hidePresentation();

                // Refresh the drop-down list
                loadStories();
            } catch (e) {
                showStatus(e.message, 'text-red-600');
            }
        };

        /* ------------------------- CREATE STORY ----------------------------------- */

        // 1. Toggle the form when ‚ÄúCreate New Story‚Äù is clicked
        createBtn.onclick = () => {
            if (!storySelect.value) {
                alert('Please select an existing story first ‚Äì it will be used as an example.');
                return;
            }
            createForm.classList.toggle('hidden');
        };


        submitBtn.onclick = async () => {
            // 1Ô∏è‚É£ Make sure an example story is loaded
            if (!storySelect.value) {
                alert('Please select an existing story to use as an example first.');
                return;
            }

            // 2Ô∏è‚É£ Gather inputs
            const subject = subjectInput.value.trim();
            const instr = instrInput.value.trim();
            const exampleJson = storyJsonArea.value;

            // 3Ô∏è‚É£ Build the LLM prompt (use your template here)
            const prompt = `
                You are an assistant that generates interactive case-study stories for medical students, helping them learn the correct treatment pathways. 
				These stories are represented as JSON following our established schema. Here is an example of an existing story (for reference):
                \`\`\`
                ${exampleJson}
                \`\`\`

                Using this schema:
1. **Top-level keys** in order:  
   - title (string)  
   - createdAt, updatedAt (timestamp objects)  
   - scenarios (object of scenario-objects)  
   - drugInfo (object of drug-info objects)  
   - summary (object with a ‚Äúpoints‚Äù array)  
   - quiz (object with a ‚Äúchoices‚Äù array)

2. **Each scenario** must have keys in this order:  
   - name (string)  
   - text (string)  
   - options (array of option-objects)

3. **Each option** must have:  
   - text (string)
   - id (string matching one of the scenario keys)
   
4. **Each drugInfo** must have:  

   - Family (string representing the Family of drugs the drug belongs to)  
   - PK (string)
   - Spectrum (string)
   - Toxicities (string)

5. **Mermaid compliance**:  
   - Scenario IDs become graph node IDs.  
   - Option texts must be short, single-line labels without unsupported Unicode.  

---

**Now** create a **brand new interactive case-study story JSON** with:  
- **Title** based on: Subject: ${subject} and on Additional instructions (if any): ${instr || 'none'}

                Output **only** the new story‚Äôs JSON, ready for Mermaid rendering.
                  `.trim();

            // 4Ô∏è‚É£ UI feedback
            submitBtn.disabled = true;
            statusMsg.textContent = 'Generating new story‚Ä¶';
            statusMsg.className = 'text-gray-700';

            try {
                // 5Ô∏è‚É£ Call your serverless function
                const res = await fetch(chatEndpoint, {
				  method: 'POST',
				  headers: { 'Content-Type': 'application/json' },
				  body: JSON.stringify({ prompt })
				});

				// first grab the body (JSON or text)
				let data;
				try {
				  data = await res.json();
				} catch {
				  const txt = await res.text();
				  throw new Error(`Invalid JSON response: ${txt}`);
				}

				// if the status isn‚Äôt OK, throw with the returned error info
				if (!res.ok) {
				  const msg = data.error || JSON.stringify(data);
				  throw new Error(`API error ${res.status}: ${msg}\n${data.stack||''}`);
				}

				// otherwise you‚Äôve got your reply
				const reply = data.reply;


                // 6Ô∏è‚É£ Load into the textarea & re-render
                // Clean up code fences, if present
				let cleaned = reply.trim();
				if (cleaned.startsWith('```')) {
				  cleaned = cleaned
					.replace(/^```(?:json)?\s*/, '')  // remove opening ``` or ```json
					.replace(/```$/, '');             // remove trailing ```
				}
				// put JSON in textarea
				storyJsonArea.value = cleaned;
				// derive a slug from the new title and set it as the Story ID
				try {
				  const newStory = JSON.parse(cleaned);
				  const title    = newStory.title || '';
				  // lowercase, then replace every non-a‚Äìz or 0‚Äì9 with a hyphen
				  const slug     = title
									  .toLowerCase()
									  .replace(/[^a-z0-9]/g, '-')
									  // collapse multiple hyphens
									  .replace(/-+/g, '-')
									  // trim hyphens off ends
									  .replace(/(^-|-$)/g, '');
				  storyIdInput.value = slug;
				} catch (e) {
				  console.warn('Could not parse new story JSON for title ‚Üí ID slug', e);
				}

                setupPresentation();

                // 7Ô∏è‚É£ Hide form + success message
                createForm.classList.add('hidden');
                statusMsg.textContent = '‚úÖ New story loaded!';
                statusMsg.className = 'text-green-600';
            } catch (e) {
                statusMsg.textContent = `Error: ${e.message}`;
                statusMsg.className = 'text-red-600';
            } finally {
                submitBtn.disabled = false;
            }
        };


    </script>
</body>
</html>
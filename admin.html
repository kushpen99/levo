<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Story Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mermaid -->
    <script src="https://unpkg.com/mermaid@9.4.3/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: false });
    </script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-2xl font-bold mb-4">ðŸ“‹ Story Admin</h1>

        <!-- AUTH ------------------------------------------------------------------>
        <div id="auth-section" class="mb-6">
            <button id="sign-in-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Sign in with Google</button>
            <button id="sign-out-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded ml-2 hidden">Sign out</button>
        </div>

        <!-- MAIN UI --------------------------------------------------------------->
        <div id="admin-interface" class="hidden bg-white p-6 rounded shadow space-y-4">
            <div>
                <label for="story-select" class="font-semibold mb-1 block">Existing Stories</label>
                <select id="story-select" class="border px-3 py-2 rounded w-full">
                    <option value="">-- Select a story --</option>
                </select>
            </div>

            <div>
                <label for="story-id" class="font-semibold block mb-1">Story ID</label>
                <input id="story-id" type="text" class="border px-3 py-2 rounded w-full" />
            </div>

            <div>
                <label for="story-json" class="font-semibold block mb-1">Story JSON</label>
                <textarea id="story-json" rows="15" class="border px-3 py-2 rounded w-full font-mono text-sm"></textarea>
            </div>

            <button id="upload-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Save to Firestore</button>
            <p id="status-msg" class="mt-2"></p>

            <!-- PRESENTATION CONTROLS ------------------------------------------->
            <div id="presentation-controls" class="hidden mt-6">
                <label for="presentation-select" class="font-semibold mr-2">View:</label>
                <select id="presentation-select" class="border px-2 py-1 rounded"></select>
            </div>

            <!-- PRESENTATION AREA -->
            <div id="presentation-area" class="hidden bg-white p-4 rounded shadow mt-4 overflow-auto">
                <div id="presentation-content" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- JS (ESM) ----------------------------------------------------------------->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

        /* -------------------------- Firebase Init -------------------------- */
        const firebaseConfig = {
            apiKey: "AIzaSyClEgpGrVTXT2zQNNDBDg0TNX2F24k6oTg",
            authDomain: "urushka99.firebaseapp.com",
            projectId: "urushka99",
            storageBucket: "urushka99.firebasestorage.app",
            messagingSenderId: "954120822793",
            appId: "1:954120822793:web:6c316b1b178081b56758d8",
            measurementId: "G-5LCB9E7PL9"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        /* -------------------------- UI Elements --------------------------- */
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const adminUI = document.getElementById('admin-interface');

        const storySelect = document.getElementById('story-select');
        const storyIdInput = document.getElementById('story-id');
        const storyJsonArea = document.getElementById('story-json');
        const uploadBtn = document.getElementById('upload-btn');
        const statusMsg = document.getElementById('status-msg');

        const presControls = document.getElementById('presentation-controls');
        const presSelect = document.getElementById('presentation-select');
        const presArea = document.getElementById('presentation-area');
        const presContent = document.getElementById('presentation-content');

        /* --------------------------- Auth ---------------------------------- */
        signInBtn.onclick = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(e => showStatus(e.message, 'text-red-600'));
        };
        signOutBtn.onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            const signedIn = !!user;
            signInBtn.classList.toggle('hidden', signedIn);
            signOutBtn.classList.toggle('hidden', !signedIn);
            adminUI.classList.toggle('hidden', !signedIn);
            if (signedIn) loadStories();
        });

        /* ------------------------- Firestore ops -------------------------- */
        async function loadStories() {
            storySelect.innerHTML = '<option value="">-- Select a story --</option>';
            const snap = await getDocs(collection(db, 'stories'));
            snap.forEach((docSnap) => {
                const { id } = docSnap;
                const d = docSnap.data();
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = d.title || d.name || id;
                storySelect.append(opt);
            });
        }

        /* ------------------------- UI behaviour --------------------------- */
        storySelect.onchange = async () => {
            const id = storySelect.value;
            if (!id) return hidePresentation();

            storyIdInput.value = id;
            const snap = await getDoc(doc(db, 'stories', id));
            if (!snap.exists()) return hidePresentation();
            const data = snap.data();

            // reorder keys for nicer reading
            const fixed = ['title', 'createdAt', 'updatedAt', 'scenarios', 'drugInfo', 'summary', 'quiz'];
            const ordered = {};
            fixed.forEach(k => { if (data[k] !== undefined) ordered[k] = data[k]; });
            Object.keys(data).forEach(k => { if (!fixed.includes(k)) ordered[k] = data[k]; });
            storyJsonArea.value = JSON.stringify(ordered, null, 2);
            setupPresentation();
        };

        // whenever user types JSON manually, reâ€‘render
        storyJsonArea.oninput = () => {
            try { JSON.parse(storyJsonArea.value); } catch { return; }
            setupPresentation();
        };

        /* --------------------- Presentation logic ------------------------- */
        function setupPresentation() {
            let data;
            try { data = JSON.parse(storyJsonArea.value); } catch { return hidePresentation(); }

            // build dropdown fresh each time
            presSelect.innerHTML = '';
            const opts = [];
            if (data.scenarios) opts.push({ val: 'graph', label: 'Graph' });
            if (data.drugInfo) opts.push({ val: 'drugInfo', label: 'Drug Info' });
            if (data.quiz) opts.push({ val: 'quiz', label: 'Quiz' });
            if (data.summary) opts.push({ val: 'summary', label: 'Summary' });
            if (!opts.length) return hidePresentation();

            opts.forEach(o => {
                const e = document.createElement('option');
                e.value = o.val;
                e.textContent = o.label;
                presSelect.append(e);
            });

            presControls.classList.remove('hidden');
            presArea.classList.remove('hidden');
            presSelect.onchange = renderPresentation;
            renderPresentation(); // initial
        }

        function renderPresentation() {
            let data;
            try { data = JSON.parse(storyJsonArea.value); } catch { return; }
            presContent.innerHTML = '';
            const mode = presSelect.value;

            /* ----------------------- GRAPH ----------------------- */
            if (mode === 'graph') {
                const nodes = [], edges = [], idMap = {};
                Object.entries(data.scenarios || {}).forEach(([k, s], i) => {
                    idMap[k] = 'n' + i;
                    const label = (s.name || '').replace(/"/g, '\\"').replace(/\n/g, ' ');
                    nodes.push(`${idMap[k]}["${label}"]`);
                });
                Object.entries(data.scenarios || {}).forEach(([k, s]) => {
                    const from = idMap[k];
                    (s.options || []).forEach(o => {
                        const to = idMap[o.id || o.next || o.target];
                        if (to) {
                            const txt = (o.text || '').replace(/"/g, '\\"').replace(/\n/g, ' ');
                            edges.push(`${from} -->|${txt}| ${to}`);
                        }
                    });
                });
                const diagram = ['flowchart LR', ...nodes, ...edges].join('\n');
                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = diagram;
                presContent.append(div);
                mermaid.init(undefined, div);
            }

            /* -------------------- DRUG INFO ---------------------- */
            if (mode === 'drugInfo') renderDrugInfo(data);

            /* ----------------------- QUIZ ------------------------ */
            if (mode === 'quiz') renderQuiz(data);

            /* --------------------- SUMMARY ----------------------- */
            if (mode === 'summary') renderSummary(data);
        }

        /* ------------------ Render helpers --------------------- */
        function renderSummary(data) {
            const ta = document.createElement('textarea');
            ta.className = 'border px-2 py-1 w-full h-32';
            ta.value = (data.summary?.points || []).join('\n');
            ta.oninput = () => {
                const full = JSON.parse(storyJsonArea.value);
                full.summary = { points: ta.value.split('\n') };
                storyJsonArea.value = JSON.stringify(full, null, 2);
            };
            presContent.append(ta);
        }

        function renderQuiz(data) {
            const addBtn = document.createElement('button');
            addBtn.textContent = 'Add Question';
            addBtn.className = 'mb-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded';
            addBtn.onclick = () => {
                const full = JSON.parse(storyJsonArea.value);
                full.quiz = full.quiz || { choices: [] };
                full.quiz.choices.push({ id: `Q${full.quiz.choices.length + 1}`, question: '', options: [], correct: '' });
                storyJsonArea.value = JSON.stringify(full, null, 2);
                renderPresentation();
            };
            presContent.append(addBtn);

            const table = document.createElement('table');
            table.className = 'table-auto w-full border-collapse';
            table.innerHTML = `
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border px-2 py-1">#</th>
                            <th class="border px-2 py-1">ID</th>
                            <th class="border px-2 py-1">Question</th>
                            <th class="border px-2 py-1">Options (commaâ€‘sep)</th>
                            <th class="border px-2 py-1">Correct</th>
                            <th class="border px-2 py-1">Remove</th>
                        </tr>
                    </thead>`;
            const tbody = document.createElement('tbody');
            (data.quiz?.choices || []).forEach((c, i) => {
                const tr = document.createElement('tr');

                // index
                tr.append(tdText(i + 1));

                // id
                tr.append(tdInput(c.id || '', (val) => updateQuizField(i, 'id', val)));

                // question
                tr.append(tdInput(c.question || '', (val) => updateQuizField(i, 'question', val), 'w-64'));

                // options
                tr.append(tdInput((c.options || []).join(', '), (val) => updateQuizField(i, 'options', val.split(',').map(s => s.trim()).filter(Boolean))));

                // correct
                tr.append(tdInput(c.correct || '', (val) => updateQuizField(i, 'correct', val)));

                // remove
                const tdR = document.createElement('td');
                tdR.className = 'border px-2 py-1 text-center';
                const remBtn = document.createElement('button');
                remBtn.textContent = 'ðŸ—‘';
                remBtn.onclick = () => {
                    const full = JSON.parse(storyJsonArea.value);
                    full.quiz.choices.splice(i, 1);
                    storyJsonArea.value = JSON.stringify(full, null, 2);
                    renderPresentation();
                };
                tdR.append(remBtn);
                tr.append(tdR);

                tbody.append(tr);
            });
            table.append(tbody);
            presContent.append(table);

            // helpers
            function tdText(txt) {
                const td = document.createElement('td');
                td.className = 'border px-2 py-1';
                td.textContent = txt;
                return td;
            }
            function tdInput(value, onChange, extra = '') {
                const td = document.createElement('td');
                td.className = `border px-2 py-1 ${extra}`;
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.value = value;
                inp.className = 'border rounded px-1 py-0.5 w-full';
                inp.oninput = () => onChange(inp.value);
                td.append(inp);
                return td;
            }
            function updateQuizField(idx, field, value) {
                const full = JSON.parse(storyJsonArea.value);
                full.quiz.choices[idx][field] = value;
                storyJsonArea.value = JSON.stringify(full, null, 2);
            }
        }

        function renderDrugInfo(data) {
            const addBtn = document.createElement('button');
            addBtn.textContent = 'Add Drug';
            addBtn.className = 'mb-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded';
            addBtn.onclick = () => {
                const full = JSON.parse(storyJsonArea.value);
                full.drugInfo = full.drugInfo || {};
                let base = 'NewDrug';
                let idx = 1;
                while (full.drugInfo[base + idx]) idx++;
                full.drugInfo[base + idx] = { PK: '', Spectrum: '', Toxicities: '' };
                storyJsonArea.value = JSON.stringify(full, null, 2);
                renderPresentation();
            };
            presContent.append(addBtn);

            const table = document.createElement('table');
            table.className = 'table-auto w-full border-collapse';
            table.innerHTML = `
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border px-2 py-1">Name</th>
                            <th class="border px-2 py-1">PK</th>
                            <th class="border px-2 py-1">Spectrum</th>
                            <th class="border px-2 py-1">Toxicities</th>
                            <th class="border px-2 py-1">Remove</th>
                        </tr>
                    </thead>`;
            const tbody = document.createElement('tbody');
            Object.entries(data.drugInfo || {}).forEach(([name, info]) => {
                const tr = document.createElement('tr');

                // Name (editable, unique key!)
                const tdName = document.createElement('td');
                tdName.className = 'border px-2 py-1';
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = name;
                nameInput.className = 'border rounded px-1 py-0.5 w-full';
                nameInput.oninput = () => renameDrug(name, nameInput.value);
                tdName.append(nameInput);
                tr.append(tdName);

                ['PK', 'Spectrum', 'Toxicities'].forEach((field) => {
                    const td = document.createElement('td');
                    td.className = 'border px-2 py-1';
                    const inp = document.createElement('input');
                    inp.type = 'text';
                    inp.value = info[field] || '';
                    inp.className = 'border rounded px-1 py-0.5 w-full';
                    inp.oninput = () => updateDrug(name, field, inp.value);
                    td.append(inp);
                    tr.append(td);
                });

                const tdRem = document.createElement('td');
                tdRem.className = 'border px-2 py-1 text-center';
                const remBtn = document.createElement('button');
                remBtn.textContent = 'ðŸ—‘';
                remBtn.onclick = () => removeDrug(name);
                tdRem.append(remBtn);
                tr.append(tdRem);

                tbody.append(tr);
            });
            table.append(tbody);
            presContent.append(table);

            function renameDrug(oldName, newName) {
                if (!newName || oldName === newName) return;
                const full = JSON.parse(storyJsonArea.value);
                if (full.drugInfo[newName]) return; // already exists
                full.drugInfo[newName] = { ...full.drugInfo[oldName] };
                delete full.drugInfo[oldName];
                storyJsonArea.value = JSON.stringify(full, null, 2);
                renderPresentation();
            }
            function updateDrug(dName, field, value) {
                const full = JSON.parse(storyJsonArea.value);
                full.drugInfo[dName][field] = value;
                storyJsonArea.value = JSON.stringify(full, null, 2);
            }
            function removeDrug(dName) {
                const full = JSON.parse(storyJsonArea.value);
                delete full.drugInfo[dName];
                storyJsonArea.value = JSON.stringify(full, null, 2);
                renderPresentation();
            }
        }

        /* ------------------- Utility Helpers -------------------- */
        function hidePresentation() {
            presControls.classList.add('hidden');
            presArea.classList.add('hidden');
            presContent.innerHTML = '';
        }
        function showStatus(txt, cls = '') {
            statusMsg.textContent = txt;
            statusMsg.className = cls;
        }

        /* -------------------- Upload / Save -------------------- */
        uploadBtn.onclick = async () => {
            const id = storyIdInput.value.trim();
            const raw = storyJsonArea.value;
            if (!id || !raw) return showStatus('Story ID and JSON required.', 'text-red-600');

            let obj;
            try { obj = JSON.parse(raw); } catch { return showStatus('Invalid JSON.', 'text-red-600'); }

            const ref = doc(db, 'stories', id);
            const snap = await getDoc(ref);
            const save = { ...obj, updatedAt: serverTimestamp(), createdAt: snap.exists() ? snap.data().createdAt : serverTimestamp() };
            await setDoc(ref, save);
            showStatus(`Story "${id}" saved.`, 'text-green-600');
            loadStories();
        };
    </script>
</body>
</html>
